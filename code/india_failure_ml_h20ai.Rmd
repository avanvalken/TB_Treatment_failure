---
title: "india_failure_ml_h20ai"
author: "avanvalken"
date: "4/27/2022"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: "flatly"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(SummarizedExperiment)
  library(edgeR)
  library(sva)
  library(SingleCellExperiment)
  library(singleCellTK)
  library(DESeq2)
  library(TBSignatureProfiler)
  library(DT)
  library(enrichR)
  library(Rtsne)
  library(umap)
  library(ggplot2)
  library(ComplexHeatmap)
  library(tidyverse)
  library(knitr)
  library(kableExtra)
  library(h2o)
  
  
})

knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(echo = FALSE)
##knitr::opts_chunk$set(dev = "svg", dpi = 300)
```


# Load data
```{r}
indata <- readRDS("data/india_se.RDS")
dim(indata)

# Want to have 5% present rate
indata <- indata[apply(assay(indata,"counts") != 0, 1, mean)>.2,] 
dim(indata)

# removing outlier based on PCA
indata <- indata[,-which(colnames(indata) %in% c("10200107A0"))]

colData(indata)$subjtype <- as.factor(colData(indata)$subjtype)
colData(indata)$batch <- as.factor(colData(indata)$batch)
colData(indata)$visit <- as.factor(colData(indata)$visit)
colData(indata)$visit_type <- as.factor(paste(colData(indata)$visit, colData(indata)$subjtype, sep = "_"))
```

# Batch correct

## UMAP of uncorrected data
```{r}




assay_type = "counts"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))
embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$subjtype)
embedding$batch <- as.factor(indata$batch)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch, label = colnames(assay(indata, assay_type)))) + 
  geom_point(size=1.5) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)
```
## Batch correct on subjid and subjtype

separate based on time

```{r}
modcombat <- model.matrix(~  as.factor(colData(indata)$visit) + colData(indata)$subjtype)

combined_India.combatSeqCorrect <- ComBat_seq(assay(indata, "counts"),
                                      colData(indata)$batch, group=NULL,
                                      covar_mod=modcombat)

assay(indata, "combatseq") <- combined_India.combatSeqCorrect
assays(indata)
indata <- mkAssay(indata, input_name = "combatseq", log = TRUE)
assays(indata)


rm(modcombat, combined_India.combatSeqCorrect)
```



## UMAP on adjusted data

```{r}
assay_type = "log_combatseq"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$subjtype)
embedding$batch <- as.factor(indata$batch)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch, label = colnames(assay(indata, assay_type)))) + 
  geom_point(size=1.5) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)
```

# Add duplicates together for 1 batch

## Combine duplicates
```{r}
df <- as.data.frame(colData(indata))
mat <- as.matrix(assay(indata, "combatseq"))

# get list of duplicated subjid's, X column

doubled <- df[duplicated(df$subjid), c('subjid', "X")]

x <- which( colnames(mat) %in% doubled$subjid)
y <- which( colnames(mat) %in% doubled$X)



# add columns of counts for those id's

mat[,"10200129A0"] <- rowSums(mat[,c("10200129A0", "X_10200129A0")])
mat[,"10200133A0"] <- rowSums(mat[,c("10200133A0", "X_10200133A0")])
mat[,"10200169A0"] <- rowSums(mat[,c("10200169A0", "X_10200169A0")])
mat[,"10200184A0"] <- rowSums(mat[,c("10200184A0", "X_10200184A0")])
mat[,"10200207A0"] <- rowSums(mat[,c("10200207A0", "X_10200207A0")])
mat[,"10200208A"] <- rowSums(mat[,c("10200208A", "X_10200208A0")])
mat[,"10200215A0"] <- rowSums(mat[,c("10200215A0", "X_10200215A0")])
mat[,"10200219A0"] <- rowSums(mat[,c("10200219A0", "X_10200219A0")])
mat[,"10200230A0"] <- rowSums(mat[,c("10200230A0", "X_10200230A0")])
mat[,"10200248A0"] <- rowSums(mat[,c("10200248A0", "X_10200248A0")])
mat[,"10200253A0"] <- rowSums(mat[,c("10200253A0", "X_10200253A0")])
mat[,"10200265A0"] <- rowSums(mat[,c("10200265A0", "X_10200265A0")])
mat[,"10200266A0"] <- rowSums(mat[,c("10200266A0", "X_10200266A0")])
mat[,"10200274A0"] <- rowSums(mat[,c("10200274A0", "X_10200274A0")])
mat[,"10200280A0"] <- rowSums(mat[,c("10200280A0", "X_10200280A0")])
mat[,"10200309A0"] <- rowSums(mat[,c("10200309A0", "X_10200309A0")])
mat[,"10200318A0"] <- rowSums(mat[,c("10200318A0", "X_10200318A0")])
mat[,"10200366A0"] <- rowSums(mat[,c("10200366A0", "X_10200366A0")])

mat <- mat[,-y]


# get rid of duplicates in coldata
indata <- indata[,-which(colnames(indata) %in% doubled$X)]

#matnames <- colnames(mat)
#matnames <- gsub("X_", "", matnames)

#colnames(mat) <- matnames




# make assays using combined counts data
indata <- SummarizedExperiment(assays= mat, colData = colData(indata))
names(assays(indata)) <- "counts"

indata <-  mkAssay(indata, log = TRUE)# this is the new indata object
names(assays(indata)) <- c("counts", "log_counts", "cpm", "log_cpm")

## extract CPM for CIBERSORT

# cpm_failure <- assay(indata, "cpm", withDimnames = TRUE)
# 
# outCibersort <- cbind(data.frame(GeneSymbol = row.names(cpm_failure)), 
#                      cpm_failure)
# row.names(outCibersort) <- NULL
# head(outCibersort)
# write.table(outCibersort, 
#             file="expr_mat_tb_fail.txt", 
#             quote=FALSE, sep='\t', col.names = TRUE, row.names = FALSE)

```

## UMAP on adjusted data, after combining same subjid/timepoint

```{r umap-all}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$subjtype)
embedding$batch <- as.factor(indata$batch)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch, label = colnames(assay(indata, assay_type)))) + 
  geom_point(size=1.5) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)
```




# Prediction who fails at base line
## Dimension Reduction failures and controls of baseline

### PCA  {.tabset}
Using the DESeq object and PCAplot function on the ComBat corrected data


```{r base-pca}



indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]
table(colData(indata)$"subjtype")
table(colData(indata_base)$"subjtype")

indata_tmp <- SummarizedExperiment(assays=list(counts=assays(indata_base)$log_cpm), colData = colData(indata_base))

#indata_tmp <- indata_tmp[,-which(colnames(indata_tmp) %in% c("10200107A0"))]

names(indata_tmp) <- NULL

indata_tmp2 <- as(indata_tmp, "SingleCellExperiment")
#plotPCA(DESeqTransform(indata_tmp))



g <- singleCellTK::plotPCA(indata_tmp2, colorBy = "subjtype", useAssay = "counts", runPCA = TRUE)


#g <- plotPCA(DESeqTransform(indata_tmp), intgroup = "subjtype")

g <- g + geom_point(size = .5) + ggtitle("PCA Baseline")
g

# svg(filename = "base_pca_mdx_included.svg", width = 4, height = 4, pointsize = 5)
# g
# dev.off()
```

### tSNE {.tabset}


```{r base-tsne, fig.cap="tSNE", fig.height=4, fig.width=4,  echo=FALSE}
assay_type = "log_cpm"

indata_base = indata[,colData(indata)$visit=="Baseline"]


set.seed(1)
tsne_out <- Rtsne(t(assay(indata_base,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=10, theta=0.5, dims=2)

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- (as.factor(indata_base$subjtype ))


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata_base,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot")

plot(g)
```


### UMAP {.tabset}

split up based on time

```{r base-umap, fig.cap="UMAP", fig.height=4, fig.width=4, echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata_base,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata_base$subjtype)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata_base,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP Plot")

plot(g)
```
## Differential Expression at baseline {.tabset}

```{r }
#designMat <- model.matrix(~factor(Tb_status) + factor(bmi_cat2) + factor(Tb_status):factor(bmi_cat2), data=colData(indata_base))

#designMat <- model.matrix(~factor(Tb_status) + factor(bmi_cat2), data=colData(indata_base))

designMat <- model.matrix(~factor(subjtype) , data=colData(indata_base))

colnames(designMat)
colnames(designMat) <- c("Intercept", "Control")

head(designMat)

fit <- lmFit(assay(indata_base, "log_cpm"), designMat)

# Difference in expression between failures and controls 

contrast.matrixNut<- makeContrasts(Control, levels = designMat)
fitNut <- contrasts.fit(fit,contrast.matrixNut)
fitNut <- eBayes(fitNut)
limmaResNut <- topTable(fitNut, adjust.method = "BH", n = Inf, sort.by = "P")


dim(limmaResNut[limmaResNut$adj.P.Val <0.05,])
table(colData(indata_base)$subjtype)

new_hist_padjval_100breaks <- hist(limmaResNut$adj.P.Val, breaks=100)
new_hist_pval_100breaks <- hist(limmaResNut$P.Value, breaks=100)
##shows spike near 0

sig_limmaResNut <- limmaResNut[limmaResNut$adj.P.Val <0.05,]
sig_limmaResNut <- sig_limmaResNut[order(sig_limmaResNut$adj.P.Val),]

#write.csv(sig_limmaResNut, "sig_tbfail_india_baseline.csv")

top_500_genes <- limmaResNut[1:500,]
top_1k_genes <- limmaResNut[1:1000,]
## top 50 by logfc
###top 50 by p.adj value
top_50 <- sig_limmaResNut[1:50,]
#write.csv(top_50, "top_50_by_padj.csv")


neg_25_log <- (sig_limmaResNut[sig_limmaResNut$logFC < 0,])
neg_25_log <- neg_25_log[order(neg_25_log$logFC),]
neg_25_log <- neg_25_log[1:25,]

#write.csv(neg_25_log, "neg_25_logfc.csv")

top25_lot <- sig_limmaResNut[sig_limmaResNut$logFC >= 0,]
top25_log <- top25_lot[order(-top25_lot$logFC),]
top25_log <- top25_log[1:25,]

#write.csv(top25_log, "top_25_logfc.csv")

```



### 2 All genes datatable and heatmap {.tabset}
```{r base-diffex-top1k}
datatable(sig_limmaResNut, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

## Make a Heatmap of all genes
mat = as.matrix(assay(indata_base[row.names(top_1k_genes),],"log_cpm"))
mat = t(scale(t(mat)))

df=data.frame(Outcome=colData(indata_base)$"subjtype") 
# 
# df=df[order(df$BMI),]

#o1 = seriate(dist(mat), method = "TSP")
#o2 = seriate(dist(t(mat)), method = "TSP")

ha = HeatmapAnnotation(df = df, col = list(Outcome=c("failure"="Red","Control"="Blue")))

Heatmap(mat,show_row_names=F,show_column_names = F, top_annotation = ha, cluster_columns = T )
```




# Prediction who fails at 2 months
## Dimension Reduction failures and controls at 2 months 

### PCA  {.tabset}
Using the DESeq object and PCAplot function on the ComBat corrected data


```{r M2-PCA, fig.cap="PCA plot created with the DESeq object and PCAplot function on the Combat-Seq batch corrected data.", fig.height=4, fig.width=4,  echo=FALSE}

# names(x) must be NULL or a character vector with no attributes Calls

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

indata_m2_tmp= indata[,colData(indata)$visit=="Month 2"]

names(indata_m2_tmp) <- NULL
indata_tmp <- SummarizedExperiment(assays=list(counts=assays(indata_m2_tmp)$log_cpm),colData = colData(indata_m2))
names(indata_tmp) <- NULL


# g <- singleCellTK::plotPCA(indata_tmp, colorBy = "subjtype", useAssay = "counts", runPCA = TRUE)
# 
# 
# g <- g + geom_point(size = .5) + ggtitle("PCA Month 2")
# g

# svg(filename = "m2_pca_mdx_included.svg", width = 4, height = 4, pointsize = 5)
# g
# dev.off()

plotPCA(DESeqTransform(indata_tmp), intgroup = "subjtype")
```

### tSNE {.tabset}


```{r M2-tsne, fig.cap="tSNE", fig.height=4, fig.width=4,  echo=FALSE, eval=FALSE}
assay_type = "log_cpm"

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

set.seed(1)
tsne_out <- Rtsne(t(assay(indata_m2,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=5, theta=0.5, dims=2) #changed perplexity from 10 to 5

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- (as.factor(indata_m2$subjtype ))


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata_m2,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot")

plot(g)
```


### UMAP {.tabset}


```{r M2-UMAP, fig.cap="UMAP", fig.height=4, fig.width=4, echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata_m2,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata_m2$subjtype)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata_m2,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP Plot")

plot(g)
```
## Differential Expression at 2 months {.tabset} 

```{r}

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

designMat <- model.matrix(~factor(subjtype) , data=colData(indata_m2))

colnames(designMat)
colnames(designMat) <- c("Intercept", "Control")
# 1=Failure, 0 = Control

head(designMat)

fit <- lmFit(assay(indata_m2, "log_cpm"), designMat)

# Difference in expression between malnourished individuals and well-nourished LTBI individuals, among malnourished individuals

contrast.matrixNut<- makeContrasts(Control, levels = designMat)
fitNut <- contrasts.fit(fit,contrast.matrixNut)
fitNut <- eBayes(fitNut)
limmaResNut <- topTable(fitNut, adjust.method = "BH", n = Inf, sort.by = "P")


dim(limmaResNut[limmaResNut$adj.P.Val <0.05,])
table(colData(indata_m2)$subjtype)

new_hist_padjval_100breaks <- hist(limmaResNut$adj.P.Val, breaks=100)
new_hist_pval_100breaks <- hist(limmaResNut$P.Value, breaks=100)
##shows spike near 0

sig_limmaResNut <- limmaResNut[limmaResNut$adj.P.Val <0.05,]
sig_limmaResNut <- sig_limmaResNut[order(sig_limmaResNut$adj.P.Val),]

#write.csv(sig_limmaResNut, "sig_TBgenes_padj.csv")

top_500_genes <- limmaResNut[1:500,]
top_1k_genes <- limmaResNut[1:1000,]
## top 50 by logfc
###top 50 by p.adj value
top_50 <- sig_limmaResNut[1:50,]
write.csv(limmaResNut[1:3000,], "m2_tbfail_top3k.csv")


neg_25_log <- (sig_limmaResNut[sig_limmaResNut$logFC < 0,])
neg_25_log <- neg_25_log[order(neg_25_log$logFC),]
neg_25_log <- neg_25_log[1:25,]

#write.csv(neg_25_log, "neg_25_logfc.csv")

top25_lot <- sig_limmaResNut[sig_limmaResNut$logFC >= 0,]
top25_log <- top25_lot[order(-top25_lot$logFC),]
top25_log <- top25_log[1:25,]

#write.csv(top25_log, "top_25_logfc.csv")

```



### 2 All genes datatable and heatmap {.tabset}
```{r M2-diffex-heatmap}
datatable(sig_limmaResNut, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

## Make a Heatmap of all genes
mat = as.matrix(assay(indata_m2[row.names(top_1k_genes),],"log_cpm"))
mat = t(scale(t(mat)))

df=data.frame(Outcome=colData(indata_m2)$"subjtype") 
# 
# df=df[order(df$BMI),]

#o1 = seriate(dist(mat), method = "TSP")
#o2 = seriate(dist(t(mat)), method = "TSP")

ha = HeatmapAnnotation(df = df, col = list(Outcome=c("failure"="Red","Control"="Blue")))

Heatmap(mat,show_row_names=F,show_column_names = F, top_annotation = ha, cluster_columns = T )
```




# New sig {.tabset}
```{r}
indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]

library(ROCR)
set.seed(101) 
sample <- sample.int(n = nrow(colData(indata_base)), size = floor(.75*nrow(colData(indata_base))), replace = F)

df <- as.data.frame(colData(indata_base))
df_train <- df[sample,]
df_test <- df[-sample,]

train <- indata_base[,colData(indata_base)$subjid %in% df_train$subjid]
test  <- indata_base[, colData(indata_base)$subjid %in% df_test$subjid]

train_subjid <- colData(train)$subjid
test_subjid <- colData(test)$subjid

dim(train)
table(colData(train)$subjtype)

table(colData(test)$subjtype)

# matrix of log_cpm for all genes in baseline
bl_mat <- t(as.matrix(assay(indata_base, "log_cpm")))
# only include significant genes in matrix
#sig_bl_mat <- as.data.frame(t(bl_mat[rownames(dfx),]))

df <- as.data.frame(colData(indata_base))

#sig_bl_mat$subjtype <- df$subjtype

bl_mat <- as.data.frame(bl_mat)
bl_mat$subjtype <- df$subjtype

```

## h2o.ai
```{r}
#library(h2o)
# Start the H2O cluster (locally)
h2o.init()

# make h20.ai object
mat_h2o <- as.h2o(bl_mat) 
predictors <- colnames(mat_h2o[,-length(mat_h2o)])
y <- 'subjtype'

#mat_splits <- h2o.splitFrame(data = mat_h2o, 
     #                         ratios = 0.8, seed = 1)
train <- as.h2o(bl_mat[train_subjid,])
test <- as.h2o(bl_mat[test_subjid,])


```

## H2O Kmeans
```{r, eval=FALSE}
kmeans_model <- h2o.kmeans(training_frame = train, 
                           x = predictors, k = 3,
                           seed = 1)
h2o.centers(kmeans_model)
```


```{r, eval=F, echo=F}
mat_automl <- h2o.automl(x = predictors, y = y, 
                          training_frame = train, 
                          max_runtime_secs = 0) # , 
                          #validation_frame = valid) must have 200 weighted rows?
```



## H2O AutoML leaderboard
```{r, eval=T}

lb <- h2o.get_leaderboard(mat_automl)
head(lb)
```

## H2O get leader
```{r}
m <- mat_automl@leader
m1 <- h2o.getModel("DRF_1_AutoML_1_20220511_134727")
m2 <- h2o.getModel("XRT_1_AutoML_1_20220511_134727")  

```

```{r}
h2o.varimp_plot(m)

 

m0_gbm <-  as.character(as.data.frame(h2o.varimp(m))[1:4,"variable"])
#names(m0_gbm) <- "m0_gbm"

m1_drf <- as.character(as.data.frame(h2o.varimp(h2o.getModel("DRF_1_AutoML_1_20220511_134727")))[1:14,"variable"])
#names(m1_drf) <- "m1_drf"

m2_xrt <- as.character(as.data.frame(h2o.varimp(h2o.getModel("XRT_1_AutoML_1_20220511_134727")))[1:16,"variable"])
#names(m2_xrt) <- "m2_xrt"


#View(as.data.frame(h2o.varimp(m)))
#"RNU6-11P", "SCYL3")

m3 <- as.character(unique(unlist(c(m0_gbm, m1_drf, m2_xrt))))
```




## Test the model with TBSignatureProfiler
```{r}
indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]


assay <- "log_cpm"
samp_tbsignatures <- TBsignatures


samp_tbsignatures$'VanValkenburg_FAIL_4' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")
# samp_tbsignatures$'m1_drf' <- c("PBLD", 
#                                 "PLAGL1", 
#                                 "MSLN", 
#                                 "NHSL2", 
#                                 "TRBV5-1", 
#                                 "KIF1B", 
#                                 "H2BC20P", 
#                                 "HK2P1", 
#                                 "SSH1", 
#                                 "AC007686.3",
#                                 "EP300",
#                                 "AC024587.1",
#                                 "PRSS51", 
#                                 "TRAPPC10" )
samp_tbsignatures$'VanValkenburg_FAIL_14' <- c("STAT3",
                               "PLEKHM3",
                               "LRRFIP1",
                               #"AC009974.2",
                               "RREB1",
                               "RNASEL",
                               "SSH1",
                               "HELZ" ,
                               #"PTGIS",
                               "AC003681.1",
                               "PLEK",
                               "ANKRD28",
                               "KIF13A",
                               "RAB11FIP1P1",
                               "IDS",
                               "ANO6")
#samp_tbsignatures$'m3' <- m3

samp_tbsignatures$Chendi_HIV_2 <- NULL
#samp_tbsignatures$Kulkarni_HIV_2 <- NULL
#samp_tbsignatures$Sloot_HIV_2 <- NULL
#samp_tbsignatures$Suliman_RISK_2 <- NULL

test_indata <- indata_base[,which(colnames(indata_base) %in% test_subjid)]

train_indata <- indata_base[,which(colnames(indata_base) %in% train_subjid)]


gsva_res <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)

# gsva_res <- runTBsigProfiler(train_indata,
#                              useAssay = assay, 
#                              algorithm = "GSVA",
#                              signatures = samp_tbsignatures)
# 
# ssgsea_res <- runTBsigProfiler(train_indata,
#                              useAssay = assay, 
#                              algorithm = "ssGSEA",
#                              signatures = samp_tbsignatures)
# 
# plage_res <- runTBsigProfiler(train_indata,
#                              useAssay = assay,
#                              algorithm = "PLAGE",
#                              signatures = samp_tbsignatures)

```



#### AUC Table
```{r, message = FALSE}
set.seed(0)
d <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output="data.frame")
```









### ssGSEA {.tabset}

#### Heatmap

```{r subssgsea_a_TBsigs}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r boxssgsea_TBsigs}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("subjtype"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_ssgsea_TBsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r, message = FALSE}
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}


#### Heatmap

```{r plage_TBsigs}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxplage_TBsigs}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```



#### AUC Table ssGSEA
```{r, message = FALSE}
set.seed(0)


bl_test_AUC <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(bl_test_AUC)
#write.csv(bl_test_AUC, "bl_test_AUC_ssgsea.csv")
```

#### AUC Table PLAGE
```{r, message = FALSE}
set.seed(0)
bl_test_AUC_plage <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = TRUE,
         output = "data.frame")
View(bl_test_AUC_plage)
#write.csv(bl_test_AUC_plage, "bl_test_AUC_plage.csv", append=FALSE)
```

#### ROC plots (ind)
```{r}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```

#### Boxplot ssGSEA

```{r}

select_tbsignatures <- list(samp_tbsignatures$VanValkenburg_FAIL_14,
                      samp_tbsignatures$Anderson_42, 
                      samp_tbsignatures$Esmail_203, 
                      samp_tbsignatures$Tornheim_71,
                      samp_tbsignatures$Tornheim_RES_25,
                      samp_tbsignatures$VanValkenburg_FAIL_4, 
                      samp_tbsignatures$Leong_RISK_29,
                      samp_tbsignatures$Thompson_FAIL_13,
                      samp_tbsignatures$Thompson_RES_5,
                      samp_tbsignatures$Maertzdorf_OD_100, 
                      samp_tbsignatures$Jacobsen_3,
                      samp_tbsignatures$Jenum_8)

names(select_tbsignatures) <- c("VanValkenburg_FAIL_14",
                      "Anderson_42", 
                      "Esmail_203", 
                      "Tornheim_71",
                      "Tornheim_RES_25",
                      "VanValkenburg_FAIL_4", 
                      "Leong_RISK_29",
                      "Thompson_FAIL_13",
                      "Thompson_RES_5",
                      "Maertzdorf_OD_100", 
                      "Jacobsen_3",
                      "Jenum_8")


#svg("tbfail_ssgsea_boxplot_selectsig.svg", pointsize = 8)
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```

#### Boxplot PLAGE
```{r}
#svg("tbfail_plage_boxplot_selectsig.svg", pointsize = 8)
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```


#### Heatmap of signature
```{r}
#png("tbfail_VanValkenburg_FAIL_14_train_plage_heatmap.png", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["VanValkenburg_FAIL_14"]],
                     name = "VanValkenburg_FAIL_14_train_plage", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "VanValkenburg_FAIL_14"),
                     showColumnNames = FALSE)
#dev.off()
```

#### Heatmap of m0_gbm signature
```{r}
#svg("VanValkenburg_FAIL_4_test_plage_heatmap.svg", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["VanValkenburg_FAIL_4"]],
                     name = "VanValkenburg_FAIL_4_train_plage", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "VanValkenburg_FAIL_4"),
                     showColumnNames = FALSE)
#dev.off()
```

# TBSignatureProfiler M2
```{r}
assay <- "log_cpm"
# samp_tbsignatures <- TBsignatures
# 
# 
# samp_tbsignatures$'m0_gbm' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")
# samp_tbsignatures$'m1_drf' <- c("PBLD",
#                                 "PLAGL1",
#                                 "MSLN",
#                                 "NHSL2",
#                                 "TRBV5-1",
#                                 "KIF1B",
#                                 "H2BC20P",
#                                 "HK2P1",
#                                 "SSH1",
#                                 "AC007686.3",
#                                 "EP300",
#                                 "AC024587.1",
#                                 "PRSS51",
#                                 "TRAPPC10" )
# samp_tbsignatures$'m2_xrt' <- c("STAT3",
#                                "PLEKHM3",
#                                "LRRFIP1",
#                                "AC009974.2",
#                                "RREB1",
#                                "RNASEL",
#                                "SSH1",
#                                "HELZ" ,
#                                "PTGIS",
#                                "AC003681.1",
#                                "PLEK",
#                                "ANKRD28",
#                                "KIF13A",
#                                "RAB11FIP1P1",
#                                "IDS",
#                                "ANO6")
# 
# samp_tbsignatures$Chendi_HIV_2 <- NULL
# 





gsva_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)



```



#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_ssgsea.csv")
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_plage.csv")
```

#### ROC plots (ind)
```{r}

for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = plage_res,
                   signatureColNames = i ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}

svg("FAIL4_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_4" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_4", sep = " "))
dev.off()

svg("FAIL14_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_14" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_14", sep = " "))
dev.off()

```

#### Boxplot ssGSEA

```{r}



#svg("tb_fail_boxplot_ssgsea_m2.svg")
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```

#### Boxplot PLAGE
```{r}
png("tb_fail_boxplot_plage_m2.png")
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
dev.off()
```


#### Heatmap of signature
```{r}
png("tbfail_m2xrt_ssgsea_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[["m2_xrt"]],
                     name = "m2_xrt", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m2_xrt"),
                     showColumnNames = FALSE)
dev.off()
```

```{r}
#png("tbfail_m0gbm_plage_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["m0_gbm"]],
                     name = "m0_gbm", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m0_gbm"),
                     showColumnNames = FALSE)
#dev.off()
```



# Session Info
```{r}
sessionInfo()

```










