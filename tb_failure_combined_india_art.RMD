---
title: "india_Failure_combined"
author: "avanvalken"
date: "6/4/2021"
output:
  html_document:
    code_folding: hide
    toc: true
    toc_float: true
    theme: "flatly"
editor_options: 
  chunk_output_type: console
---


```{r setup, include=FALSE}
suppressPackageStartupMessages({
  library(SummarizedExperiment)
  library(edgeR)
  library(sva)
  library(SingleCellExperiment)
  library(singleCellTK)
  library(DESeq2)
  library(TBSignatureProfiler)
  library(DT)
  #library(enrichR)
  library(Rtsne)
  library(umap)
  library(ggplot2)
  library(ComplexHeatmap)
  library(tidyverse)
  library(knitr)
  library(kableExtra)
  library(Cairo)
})

knitr::opts_chunk$set(cache = TRUE)
knitr::opts_chunk$set(echo = FALSE)
##knitr::opts_chunk$set(dev = "svg", dpi = 300)
```


# Load data
```{r}
indata <- readRDS("data_processed/india_se.RDS")

# Want to have 5% present rate
indata <- indata[apply(assay(indata,"counts") != 0, 1, mean)>.2,] 

# removing outlier based on PCA
indata <- indata[,-which(colnames(indata) %in% c("10200107A0"))]

colData(indata)$subjtype <- gsub("failure", "Failure", colData(indata)$subjtype)
colData(indata)$subjtype <- as.factor(colData(indata)$subjtype)
colData(indata)$batch <- as.factor(colData(indata)$batch)
colData(indata)$visit <- as.factor(colData(indata)$visit)
colData(indata)$visit_type <- as.factor(paste(colData(indata)$visit, colData(indata)$subjtype, sep = "_"))
```


# Batch correct

## UMAP of uncorrected data
```{r}
assays(indata)
indata_tmp <- mkAssay(indata,  log = TRUE)
names(assays(indata_tmp)) <- c("counts", "log_counts", "cpm", "log_cpm")

assay_type = "log_cpm"


set.seed(1)
umap_out <- umap(t(assay(indata_tmp,assay_type)))
embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata_tmp$subjtype)
embedding$batch <- as.factor(indata_tmp$batch)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch, label = colnames(assay(indata_tmp, assay_type)))) + 
  geom_point(size=3) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)

# remove temporary object
rm(indata_tmp)
```
#### save
```{r=}
# ggsave("outs/dimension_reduction/batchcorrect_plots/tb_fail_umap_log_counts_pre-batch-corrected.png", width=7, height=7)
# ggsave("outs/dimension_reduction/batchcorrect_plots/tb_fail_umap_log_counts_pre-batch-corrected.svg", width=7, height=7)

```

## Batch correct on subjid and subjtype
```{r}
# matrix formula using visit and treatment status as cofactors
modcombat <- model.matrix(~  as.factor(colData(indata)$visit) + colData(indata)$subjtype)

# correct for batch effects
combined_India.combatSeqCorrect <- ComBat_seq(assay(indata, "counts"),
                                      colData(indata)$batch, group=NULL,
                                      covar_mod=modcombat)

# add batch corrected assay to indata
assay(indata, "combatseq") <- combined_India.combatSeqCorrect
assays(indata)

# make log_counts/logcpm
indata <- mkAssay(indata, input_name = "combatseq", log = TRUE)
names(assays(indata)) # check names
names(assays(indata)) <- c("counts", "combatseq", "log_counts", "cpm", "log_cpm") # rename assays for convenience

# remove for memory
rm(modcombat, combined_India.combatSeqCorrect)
```



## UMAP on adjusted data

```{r}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$subjtype)
embedding$batch <- as.factor(indata$batch)
#embedding$visit <- as.factor(indata$visit_type)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch,label = colnames(assay(indata, assay_type)))) + 
  geom_point(size=3) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)

ggsave("outs/dimension_reduction/batchcorrect_plots/tb_fail_umap_log_cpm_post-batch-corrected.png", width=7, height=7)
ggsave("outs/dimension_reduction/batchcorrect_plots/tb_fail_umap_log_cpm_post-batch-corrected.svg", width=7, height=7)
```

# Add duplicates together for 1 batch

## Combine duplicates
```{r}

df <- as.data.frame(colData(indata))
mat <- as.matrix(assay(indata, "combatseq"))

dmat <- mat
# get list of duplicated subjid's, X column

doubled <- df[duplicated(df$subjid), c('subjid', "X")]

x <- which( colnames(mat) %in% doubled$subjid)
y <- which( colnames(mat) %in% doubled$X)



# add columns of counts for those id's

mat[,"10200129A0"] <- rowSums(mat[,c("10200129A0", "X_10200129A0")])
mat[,"10200133A0"] <- rowSums(mat[,c("10200133A0", "X_10200133A0")])
mat[,"10200169A0"] <- rowSums(mat[,c("10200169A0", "X_10200169A0")])
mat[,"10200184A0"] <- rowSums(mat[,c("10200184A0", "X_10200184A0")])
mat[,"10200207A0"] <- rowSums(mat[,c("10200207A0", "X_10200207A0")])
mat[,"10200208A"] <- rowSums(mat[,c("10200208A", "X_10200208A0")])
mat[,"10200215A0"] <- rowSums(mat[,c("10200215A0", "X_10200215A0")])
mat[,"10200219A0"] <- rowSums(mat[,c("10200219A0", "X_10200219A0")])
mat[,"10200230A0"] <- rowSums(mat[,c("10200230A0", "X_10200230A0")])
mat[,"10200248A0"] <- rowSums(mat[,c("10200248A0", "X_10200248A0")])
mat[,"10200253A0"] <- rowSums(mat[,c("10200253A0", "X_10200253A0")])
mat[,"10200265A0"] <- rowSums(mat[,c("10200265A0", "X_10200265A0")])
mat[,"10200266A0"] <- rowSums(mat[,c("10200266A0", "X_10200266A0")])
mat[,"10200274A0"] <- rowSums(mat[,c("10200274A0", "X_10200274A0")])
mat[,"10200280A0"] <- rowSums(mat[,c("10200280A0", "X_10200280A0")])
mat[,"10200309A0"] <- rowSums(mat[,c("10200309A0", "X_10200309A0")])
mat[,"10200318A0"] <- rowSums(mat[,c("10200318A0", "X_10200318A0")])
mat[,"10200366A0"] <- rowSums(mat[,c("10200366A0", "X_10200366A0")])

mat <- mat[,-y]


# get rid of duplicates in coldata
indata <- indata[,-which(colnames(indata) %in% doubled$X)]

#matnames <- colnames(mat)
#matnames <- gsub("X_", "", matnames)

#colnames(mat) <- matnames




# make assays using combined counts data
indata <- SummarizedExperiment(assays= mat, colData = colData(indata))
names(assays(indata)) <- "counts"

indata <-  mkAssay(indata, log = TRUE)# this is the new indata object

names(assays(indata)) <- c("counts", "log_counts", "cpm", "log_cpm")
## extract CPM for CIBERSORT

# cpm_Failure <- assay(indata, "cpm", withDimnames = TRUE)
# 
# outCibersort <- cbind(data.frame(GeneSymbol = row.names(cpm_Failure)), 
#                      cpm_Failure)
# row.names(outCibersort) <- NULL
# head(outCibersort)
# write.table(outCibersort, 
#             file="expr_mat_tb_fail.txt", 
#             quote=FALSE, sep='\t', col.names = TRUE, row.names = FALSE)
saveRDS(indata, "data_processed/tx_failure_batchcorrected.RDS")
```

## UMAP on adjusted data, after combining same subjid/timepoint

```{r umap-all}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata$subjtype)
embedding$batch <- as.factor(indata$batch)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, shape = batch, label = colnames(assay(indata, assay_type)))) + 
  geom_point(size=3) + 
  xlab("UMAP 1") + 
  ylab("UMAP 2") + 
  theme(plot.title = element_text(hjust = 0.5)) + 
  ggtitle("UMAP Plot") #+ 
 #geom_text(aes(label=rownames(embedding), label.size = 0.10),hjust=0, vjust=0)

plot(g)
ggsave("outs/dimension_reduction/batchcorrect_plots/tb_fail_umap_log_cpm_post-batch-corrected_combined_duplicates.svg", width=7, height=7)
```



# Prediction who fails at baseline
## Dimension Reduction Failures and controls of baseline
```{r}
path <- file.path("outs/dimension_reduction/baseline")
```

### PCA  {.tabset}
Using the DESeq object and PCAplot function on the ComBat corrected data
```{r base-pca}

indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]
table(colData(indata)$"subjtype")
table(colData(indata_base)$"subjtype")

indata_tmp <- SummarizedExperiment(assays=list(counts=assays(indata_base)$log_cpm), colData = colData(indata_base))

#indata_tmp <- indata_tmp[,-which(colnames(indata_tmp) %in% c("10200107A0"))]

names(indata_tmp) <- "counts"

indata_tmp2 <- as(indata_tmp, "SingleCellExperiment")
#plotPCA(DESeqTransform(indata_tmp)) ## only uses counts assay


# need to install "scater" package
g <- singleCellTK::plotPCA(indata_tmp2, colorBy = "subjtype", useAssay = "counts", runPCA = TRUE)


g <- g + geom_point(size = 1.5) + ggtitle("PCA Baseline")
g

# save file
ggsave(file.path(path, "pca_bl.svg"),plot=g,width = 4, height = 4)
```



### tSNE {.tabset}


```{r base-tsne, fig.cap="tSNE", fig.height=4, fig.width=4,  echo=FALSE}
assay_type = "log_cpm"

indata_base = indata[,colData(indata)$visit=="Baseline"]


set.seed(1)
tsne_out <- Rtsne(t(assay(indata_base,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=10, theta=0.5, dims=2)

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- (as.factor(indata_base$subjtype ))


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata_base,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot")

plot(g)
```


### UMAP {.tabset}

split up based on time

```{r base-umap, fig.cap="UMAP", fig.height=4, fig.width=4, echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata_base,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata_base$subjtype)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata_base,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP Plot")

plot(g)

# save file
ggsave(file.path(path, "umap_bl.svg"),plot=g,width = 4, height = 4)

```
## Differential Expression at baseline {.tabset}
```{r }
# path to save
path <- file.path("outs/differential_expression")


designMat <- model.matrix(~factor(subjtype) , data=colData(indata_base))

colnames(designMat)
colnames(designMat) <- c("Intercept", "Failure")

head(designMat)

fit <- lmFit(assay(indata_base, "log_cpm"), designMat)

# Difference in expression between Failures and controls 

contrast.matrixNut<- makeContrasts(Failure, levels = designMat)
fitNut <- contrasts.fit(fit,contrast.matrixNut)
fitNut <- eBayes(fitNut)
limmaResNut <- topTable(fitNut, adjust.method = "BH", n = Inf, sort.by = "P")


dim(limmaResNut[limmaResNut$adj.P.Val <0.05,])  # 1208 genes
table(colData(indata_base)$subjtype) # 21 control 20 failure

new_hist_padjval_100breaks <- hist(limmaResNut$adj.P.Val, breaks=100)
new_hist_pval_100breaks <- hist(limmaResNut$P.Value, breaks=100)
##shows spike near 0

sig_limmaResNut <- limmaResNut[limmaResNut$adj.P.Val <0.05,]
sig_limmaResNut <- sig_limmaResNut[order(sig_limmaResNut$adj.P.Val),]

#write.csv(sig_limmaResNut, "sig_tbfail_india_baseline.csv")

top_500_genes <- limmaResNut[1:500,]
top_1k_genes <- limmaResNut[1:1000,]
## top 50 by logfc
###top 50 by p.adj value
top_50 <- sig_limmaResNut[1:50,]
#write.csv(top_50, "top_50_by_padj.csv")


neg_25_log <- (sig_limmaResNut[sig_limmaResNut$logFC < 0,])
neg_25_log <- neg_25_log[order(neg_25_log$logFC),]
neg_25_log <- neg_25_log[1:25,]

#write.csv(neg_25_log, "neg_25_logfc.csv")

top25_lot <- sig_limmaResNut[sig_limmaResNut$logFC >= 0,]
top25_log <- top25_lot[order(-top25_lot$logFC),]
top25_log <- top25_log[1:25,]

#write.csv(top25_log, "top_25_logfc.csv")

write.csv(limmaResNut[1:3000,], file.path(path,"IPA_TB_Failure_baseline.csv"))

```



### 2 All genes datatable and heatmap {.tabset}
```{r base-diffex-top1k}
datatable(sig_limmaResNut, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

## Make a Heatmap of all genes
mat = as.matrix(assay(indata_base[row.names(top_1k_genes),],"log_cpm"))
mat = t(scale(t(mat)))

df=data.frame(Outcome=colData(indata_base)$"subjtype") 
# 
# df=df[order(df$BMI),]

#o1 = seriate(dist(mat), method = "TSP")
#o2 = seriate(dist(t(mat)), method = "TSP")

ha = HeatmapAnnotation(df = df, col = list(Outcome=c("Failure"="Red","Control"="Blue")))

g <- Heatmap(mat,show_row_names=F,show_column_names = F, top_annotation = ha, cluster_columns = T )

#library(Cairo)
svg(file.path(path,"baseline_top1k.svg"), width=7, height=7 )
g
dev.off()
```






## TBSigProfiler Pathways baseline {.tabset}
```{r, message=FALSE, results='hide'}
# path to save
base_path <- file.path("outs", "tbsigprofiler_outs", "baseline")
## Add new signatures to the profiler
TBsignatures$Zhao_NANO_6 <- c("ANKRD22","ATP1A1","BLK","CCR6","DARS2","EXOC2")

TBsignatures$'CYTO6' <- c("CCL11", "IFNG", "IL15", "IL1B", "IL6", "CXCL10")

TBsignatures$Leong_RISK_29 <- c("SRBD1", "ZNF419", "SH2D1B","CTSA", "GSTA4", "AGAP9", "MOB3C", "WARS1", "LUC7L", "ZNRF1", "CIRBP", "PRSS53", "APOL6", "TCN2", "MDN1", "SNRNP70", "SLC3A1", "NAGA", "SPDYE5",  "SPSB1", "CCDC14",  "IL31RA", "DERA", "FUT4",
"NEIL1",   "ENO3",   "CCDC78", "HM13","ZNF202" )

TBsignatures$Zak_RISK_16 <- c("ANKRD22","APOL1","BATF2" ,"ETV7","FCGR1A", "FCGR1B",  "GBP1","GBP2","GBP4","GBP5", "SCARF1","SEPTIN4", "SERPING1", "STAT1","TAP1","TRAFD1")
TBsignatures$Suliman_RISK_4 <- c("GAS6", "SEPTIN4", "CD1C", "BLK")

TBsignatures$'Leong_RISK_29_up' = c("SPSB1","MOB3C","FUT4","DERA","WARS","ZNRF1","SLC3A1","SRBD1",
                                    "HM13", "CTSA","TCN2", "APOL6","NAGA","IL31RA")
TBsignatures$'Leong_RISK_29_dn' = c("SH2D1B","AGAP9","ZNF202","NEIL1","LUC7L","CCDC78","PRSS53","ENO3",
                                    "CIRBP","SNRNP70","ZNF419","CCDC14","GSTA4","MDN1","SPDYE5")


TBsignatures$protein_markers <- c("IL6", "IFNG", "IL13", "CXCL1", "CCL2", "CCL3", "CCL4", "CXCL8", "CXCL10",  "CX3CL1")
TBsignatures$Zimmer_RES_3 <- c("GBP5", "DUSP3", "KLF2")

samp_tbsignatures <- TBsignatures

samp_tbsignatures$Hoang_OD_3 <- NULL
samp_tbsignatures$Suliman_RISK_2 <- NULL
samp_tbsignatures$Chendi_HIV_2 <- NULL

gsva_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```

#### Boxplot- select sigs

```{r base-ssgsea-boxplot-selectsigs}
path <- file.path(base_path, "ssGSEA")
#library(TBSignatureProfiler)
select_tbsignatures <- list(TBsignatures$Thompson_FAIL_13,
                            TBsignatures$Thompson_9,
                            TBsignatures$Tornheim_RES_25,
                            TBsignatures$Tornheim_71, 
                            TBsignatures$Bloom_RES_558,
                            TBsignatures$Bloom_RES_268,
                            TBsignatures$Thompson_RES_5,
                            TBsignatures$Heycken_FAIL_22,
                            TBsignatures$Zimmer_RES_3)
names(select_tbsignatures) <- c("Thompson_FAIL_13",
                                "Thompson_9",
                                "Tornheim_RES_25",
                                "Tornheim_71", 
                                "Bloom_RES_558",
                                "Bloom_RES_268",
                                "Thompson_RES_5",
                                "Heycken_FAIL_22",
                                "Zimmer_RES_3")

ssgsea_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)
ssgsea_res_select.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)
ssgsea_res_select.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)

plage_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)

plage_res_select.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res_select.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)



signatureBoxplot(ssgsea_res_select, name="ssGSEA", 
                 signatureColNames = names(select_tbsignatures),
                 annotationColName = c("visit_type"), scale = TRUE,
                 rotateLabels = T) #rotateLabels = TRUE,


ggsave(file.path(path,"tbsigprofiler_selectsigs_boxplots.svg"), width = 9, height=12)
```


#### AUC tables
##### BL
```{r}
set.seed(0)


df <- tableAUC(ssgsea_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(path, "tbsigprofiler_selectsigs_AUC_boxplots_table_bl_ssGSEA.csv"))

# PLAGE
df <- tableAUC(plage_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(base_path, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_bl_PLAGE.csv"))

# PLAGE, all sigs
df <- tableAUC(plage_res.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(base_path, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_bl_PLAGE.csv"))

```

##### M2
```{r}
path.m2 <- file.path("outs/tbsigprofiler_outs/month2")
set.seed(0)
df <- tableAUC(ssgsea_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

write.csv(df, file.path(path.m2, "ssGSEA/tbsigprofiler_selectsigs_AUC_boxplots_table_m2.csv"))

df <- tableAUC(plage_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

write.csv(df, file.path(path.m2, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_m2.csv"))


```
#### AUC Boxplots
##### BL
```{r}
set.seed(0)
compareBoxplots(ssgsea_res_select.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path,"tbsigprofiler_selectsigs_AUC_boxplots_bl.svg"), width = 7, height=7)

compareBoxplots(plage_res_select.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(base_path,"PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_bl.svg"), width = 7, height=7)

compareBoxplots(plage_res.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(base_path,"PLAGE/tbsigprofiler_AUC_boxplots_bl.svg"), width = 7, height=7)

```

##### M2
```{r}
set.seed(0)
compareBoxplots(ssgsea_res_select.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"ssGSEA/tbsigprofiler_selectsigs_AUC_boxplots_m2.svg"), width = 7, height=7)

compareBoxplots(plage_res_select.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_m2.svg"), width = 7, height=7)

compareBoxplots(plage_res.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"PLAGE/tbsigprofiler_AUC_boxplots_m2.svg"), width = 7, height=7)

```

#### ROC Plots
#### functions
```{r}
sigroc <- function(inputData, annotationData, signatureColNames, annotationColName, 
  scale = FALSE, choose_colors = c("cornflowerblue", "gray24"), 
  name = "Signatures", nrow = NULL, ncol = NULL) 
{
  if (methods::is(inputData, "SummarizedExperiment")) {
    if (any(duplicated(signatureColNames))) {
      signatureColNames <- unique(signatureColNames)
    }
    if (!all(signatureColNames %in% colnames(SummarizedExperiment::colData(inputData)))) {
      stop("Signature column name not found in inputData.")
    }
    if (!all(annotationColName %in% colnames(SummarizedExperiment::colData(inputData)))) {
      stop("Annotation column name not found in inputData.")
    }
    annotationData <- data.frame(SummarizedExperiment::colData(inputData)[, 
      annotationColName, drop = FALSE])
    inputData <- data.frame(SummarizedExperiment::colData(inputData)[, 
      signatureColNames, drop = FALSE])
  }
  else {
    if (ncol(annotationData) != 1) {
      stop("annotationData must have only one column.")
    }
    annotationColName <- colnames(annotationData)
  }
  if (length(annotationColName) != 1) {
    stop("You must specify a single annotation column name with which\n    to create plots.")
  }
  if (!is.factor(annotationData[, 1])) {
    annotationData[, 1] <- as.factor(annotationData[, 1])
  }
  if (nrow(annotationData) == nrow(inputData)) {
    if (!all(rownames(annotationData) == rownames(inputData))) {
      stop("Annotation data and signature data does not match.")
    }
  }
  else if (nrow(annotationData) == ncol(inputData)) {
    if (!all(rownames(annotationData) == colnames(inputData))) {
      stop("Annotation data and signature data does not match.")
    }
    inputData <- t(inputData)
  }
  else {
    stop("Annotation data and signature data does not match.")
  }
  pathwaydata <- t(inputData)
  if (scale) {
    pathwaydata <- t(scale(t(pathwaydata)))
  }
  inputdf <- data.frame(t(pathwaydata), Group = annotationData[, 
    1])
  plot_dat <- NULL
  for (k in signatureColNames) {
    pred <- ROCit::rocit(inputdf[, k], inputdf$Group)
    plot_n <- as.data.frame(cbind(FPR = round(pred$FPR, 
      4), TPR = round(pred$TPR, 4), Signature = k))
    plot_dat <- rbind(plot_dat, plot_n)
  }
  plot_dat$Signature <- paste(plot_dat$Signature)
  plot_dat$FPR <- as.numeric(paste(plot_dat$FPR))
  plot_dat$TPR <- as.numeric(paste(plot_dat$TPR))
  return(plot_dat)
}

bl <- sigroc(inputData = ssgsea_res_select.bl,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
bl$visit <- rep("Baseline")
m2 <- sigroc(inputData = ssgsea_res_select.m2,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
m2$visit <- rep("Month 2")

plot_dat <- bind_rows(bl, m2)

theplot <- ggplot2::ggplot(data = plot_dat, aes(x = FPR, y = TPR, color=visit)) + 
  ggplot2::geom_line(ggplot2::aes(x = FPR, 
    y = TPR, color=visit), linewidth = 1) + 
    ggplot2::facet_wrap(~Signature, scales = "free", nrow = 3, 
      ncol = 3) + 
  ggplot2::geom_abline(ggplot2::aes(intercept = 0, 
    slope = 1, col = "gray24"), linewidth = 1, linetype = "dashed", 
    show.legend = FALSE) + 
  ggplot2::labs(x = "1-Specificity (FPR)", 
    y = "Sensitivity (TPR)") + 
    ggplot2::theme_classic() + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
      hjust = 1))
theplot

ggsave(file.path(path, "tbsignatureprofiler_ROC_bl-m2.svg"), width=7, height=7)
```

##### BL
```{r}
signatureROCplot(inputData = ssgsea_res_select.bl,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
```

##### M2
```{r}
signatureROCplot(inputData = ssgsea_res_select.m2,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
```


### ssGSEA {.tabset}
#### Bootstrap
```{r}
library(boot)
library(pwr)

ssgsea_df <- as.data.frame(colData(ssgsea_res))
ssgsea_df <- ssgsea_df[,-c(1:3)]
ssgsea_df <- ssgsea_df[,-c(2:24)]

ssgsea_mx <- t(ssgsea_df[,-1])

ssgsea_se <- SummarizedExperiment(assays=ssgsea_mx,
                                  colData=colData(indata_base))
names(assays(ssgsea_se)) <- "ssgsea"

sds <-apply(assay(ssgsea_se,"ssgsea"),1,sd)
summary(sds) 
#   Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#0.007625 0.015738 0.022883 0.027426 0.037734 0.066090 

maxsd<-max(sds)
minsd<-min(sds)
meansd <- mean(sds)

quants <- quantile(sds,c(0.015738 ,0.027426 ,0.037734 ))

### Calculate power

#21 controls 20 Failures
sample_size=10
alp = 0.0001

avg <- power.t.test(n = sample_size, delta = NULL, sd = quants[2], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 
large <- power.t.test(n = sample_size, delta = NULL, sd = quants[3], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 
small <- power.t.test(n = sample_size, delta = NULL, sd = quants[1], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 

small$delta
#[1] 0.01033883
avg$delta
#[1] 0.01065506
large$delta
#[1] 0.01145412
```
#### Heatmap

```{r base-ssgsea-heatmap}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r base-ssgsea-boxplot}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
```



#### Boxplots Single {.tabset}

```{r base-ssgsea-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("subjtype"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r base-ssgsea-sigplots, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r base-ssgsea-auctable, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r base-ssgsea-auc-boxplot, message = FALSE}
#svg(filename = "base-ssgsea-auc-boxplot.svg", pointsize = 8, width = 6.5, height = 3.8) 
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
#dev.off()
```

#### AUC Boxplots, selected sigs {.tabset}
```{r base-ssgsea-auc-boxplot, message = FALSE}

out <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()


png(filename = file.path(path,"RePORT-ssgsea-auc-boxplot-bl.png"), pointsize = 8, width = 6.5, height = 3.8)
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```


#### ROC plots
```{r base-ssgsea-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r base-ssgsea-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}
```{r}

```


#### Heatmap

```{r base-plage-cancer-heatmap}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r base-plage-cancer-boxplot}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r base-plage-cancer-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r base-plage-cancer-sigplots, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order = NULL)

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r base-plage-cancer-auctable, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)

out <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()


png(filename = file.path(path, "RePORT-ssgsea-auc-boxplot-bl.png"), pointsize = 8, width = 6.5, height = 3.8)
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```

#### AUC Boxplots
```{r base-plage-cancer-auc-boxplot, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)

```

#### ROC plots
```{r base-plage-cancer-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r base-plage-cancer-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


# Prediction who fails at 2 months
## Dimension Reduction Failures and controls at 2 months 

### PCA  {.tabset}
Using the DESeq object and PCAplot function on the ComBat corrected data


```{r M2-PCA, fig.cap="PCA plot created with the DESeq object and PCAplot function on the Combat-Seq batch corrected data.", fig.height=4, fig.width=4,  echo=FALSE}

# names(x) must be NULL or a character vector with no attributes Calls

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

indata_m2_tmp= indata[,colData(indata)$visit=="Month 2"]

names(indata_m2_tmp) <- NULL
indata_tmp <- SummarizedExperiment(assays=list(counts=assays(indata_m2_tmp)$log_cpm),colData = colData(indata_m2))
names(indata_tmp) <- NULL


g <- singleCellTK::plotPCA(indata_tmp2, colorBy = "subjtype", useAssay = "counts", runPCA = TRUE)


g <- g + geom_point(size = .5) + ggtitle("PCA Month 2")
g

svg(filename = "outs/dimension_reduction/month2/m2_pca.svg", width = 4, height = 4, pointsize = 5)
g
dev.off()

#plotPCA(DESeqTransform(indata_tmp), intgroup = "subjtype")
```

### tSNE {.tabset}


```{r M2-tsne, fig.cap="tSNE", fig.height=4, fig.width=4,  echo=FALSE, eval=FALSE}
assay_type = "log_cpm"

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

set.seed(1)
tsne_out <- Rtsne(t(assay(indata_m2,assay_type)), check_duplicates = FALSE, pca = TRUE, perplexity=5, theta=0.5, dims=2) #changed perplexity from 10 to 5

embedding <- as.data.frame(tsne_out$Y)
embedding$Class <- (as.factor(indata_m2$subjtype ))


g <- ggplot(embedding, 
            aes(x=V1, y=V2, color=Class), label = colnames(assay(indata_m2,assay_type))) + geom_point(size=1.5) + xlab("T-SNE 1") + ylab("T-SNE 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("TSNE Plot")

plot(g)
```


### UMAP {.tabset}


```{r M2-UMAP, fig.cap="UMAP", fig.height=4, fig.width=4, echo=FALSE}
assay_type = "log_cpm"

set.seed(1)
umap_out <- umap(t(assay(indata_m2,assay_type)))

embedding <- as.data.frame(umap_out$layout)
embedding$Class <- as.factor(indata_m2$subjtype)

g <- ggplot(embedding, aes(x=V1, y=V2, color=Class, label = colnames(assay(indata_m2,assay_type)))) + geom_point(size=1.5) + xlab("UMAP 1") + ylab("UMAP 2") + theme(plot.title = element_text(hjust = 0.5)) + 
ggtitle("UMAP Plot")

plot(g)
```

#### Save
```{r}
ggsave(filename = "outs/dimension_reduction/month2/m2_umap.svg", plot=g, device="svg", width = 4, height = 4)
```



## Differential Expression at 2 months {.tabset} 

```{r}

indata_m2 = indata[,colData(indata)$visit=="Month 2"]

designMat <- model.matrix(~factor(subjtype) , data=colData(indata_m2))

colnames(designMat)
colnames(designMat) <- c("Intercept", "Failure")

head(designMat)

fit <- lmFit(assay(indata_m2, "log_cpm"), designMat)

# Difference in expression between Failures and controls 

contrast.matrixNut<- makeContrasts(Failure, levels = designMat)
fitNut <- contrasts.fit(fit,contrast.matrixNut)
fitNut <- eBayes(fitNut)
limmaResNut <- topTable(fitNut, adjust.method = "BH", n = Inf, sort.by = "P")


dim(limmaResNut[limmaResNut$adj.P.Val <0.05,])
table(colData(indata_m2)$subjtype) #19con 20Fail

new_hist_padjval_100breaks <- hist(limmaResNut$adj.P.Val, breaks=100)
new_hist_pval_100breaks <- hist(limmaResNut$P.Value, breaks=100)
##shows spike near 0

sig_limmaResNut <- limmaResNut[limmaResNut$adj.P.Val <0.05,]
sig_limmaResNut <- sig_limmaResNut[order(sig_limmaResNut$adj.P.Val),]

write.csv(sig_limmaResNut, "outs/differential_expression/sig_tbfail_m2.csv")

top_500_genes <- limmaResNut[1:500,]
top_1k_genes <- limmaResNut[1:1000,]
## top 50 by logfc
###top 50 by p.adj value
top_50 <- sig_limmaResNut[1:50,]
#write.csv(top_50, "top_50_by_padj.csv")


neg_25_log <- (sig_limmaResNut[sig_limmaResNut$logFC < 0,])
neg_25_log <- neg_25_log[order(neg_25_log$logFC),]
neg_25_log <- neg_25_log[1:25,]

#write.csv(neg_25_log, "neg_25_logfc.csv")

top25_lot <- sig_limmaResNut[sig_limmaResNut$logFC >= 0,]
top25_log <- top25_lot[order(-top25_lot$logFC),]
top25_log <- top25_log[1:25,]

write.csv(limmaResNut[1:3000,], "outs/differential_expression/IPA_TB_Failure_month2_top3k.csv")
```



### 2 All genes datatable and heatmap {.tabset}
```{r M2-diffex-heatmap}
datatable(sig_limmaResNut, 
          options=list(scrollX=T,pageLength=20),
          rownames = T)

## Make a Heatmap of all genes
mat = as.matrix(assay(indata_m2[row.names(sig_limmaResNut),],"log_cpm"))
mat = t(scale(t(mat)))

df=data.frame(Outcome=colData(indata_m2)$"subjtype") 
# 
# df=df[order(df$BMI),]

#o1 = seriate(dist(mat), method = "TSP")
#o2 = seriate(dist(t(mat)), method = "TSP")

ha = HeatmapAnnotation(df = df, col = list(Outcome=c("Failure"="Red","Control"="Blue")))

g <- Heatmap(mat,show_row_names=F,show_column_names = F, top_annotation = ha, cluster_columns = T )

svg("outs/differential_expression/month2_137_sig_genes_heatmap.svg", width=7, height=7 )
g
dev.off()
g
```



## TBSigProfiler Pathways 2 months {.tabset}
```{r, message=FALSE, results='hide'}
indata_m2 = indata[,colData(indata)$visit=="Month 2"]


## Add new signatures to the profiler
TBsignatures$Zhao_NANO_6 <- c("ANKRD22","ATP1A1","BLK","CCR6","DARS2","EXOC2")

TBsignatures$'CYTO6' <- c("CCL11", "IFNG", "IL15", "IL1B", "IL6", "CXCL10")

TBsignatures$Leong_RISK_29 <- c("SRBD1", "ZNF419", "SH2D1B","CTSA", "GSTA4", "AGAP9", "MOB3C", "WARS1", "LUC7L", "ZNRF1", "CIRBP", "PRSS53", "APOL6", "TCN2", "MDN1", "SNRNP70", "SLC3A1", "NAGA", "SPDYE5",  "SPSB1", "CCDC14",  "IL31RA", "DERA", "FUT4",
"NEIL1",   "ENO3",   "CCDC78", "HM13","ZNF202" )

TBsignatures$Zak_RISK_16 <- c("ANKRD22","APOL1","BATF2" ,"ETV7","FCGR1A", "FCGR1B",  "GBP1","GBP2","GBP4","GBP5", "SCARF1","SEPTIN4", "SERPING1", "STAT1","TAP1","TRAFD1")
TBsignatures$Suliman_RISK_4 <- c("GAS6", "SEPTIN4", "CD1C", "BLK")

TBsignatures$'Leong_RISK_29_up' = c("SPSB1","MOB3C","FUT4","DERA","WARS","ZNRF1","SLC3A1","SRBD1",
                                    "HM13", "CTSA","TCN2", "APOL6","NAGA","IL31RA")
TBsignatures$'Leong_RISK_29_dn' = c("SH2D1B","AGAP9","ZNF202","NEIL1","LUC7L","CCDC78","PRSS53","ENO3",
                                    "CIRBP","SNRNP70","ZNF419","CCDC14","GSTA4","MDN1","SPDYE5")

#TBsignatures$VanValkenburg_6 <- c("RNF10", "RREB1", "PFKL", "NADK", "PIK3CD", "CALCR")

#selected tb signatures
# samp_tbsignatures <- list(TBsignatures$Suliman_RISK_4, TBsignatures$Sweeney_OD_3, TBsignatures$Leong_RISK_29, TBsignatures$Zak_RISK_16, TBsignatures$Leong_RISK_29_up, TBsignatures$Leong_RISK_29_dn)
# names(samp_tbsignatures) <- c("Suliman_RISK_4", "Sweeney_OD_3", "Leong_RISK_29", "Zak_RISK_16", "Leong_RISK_29_up", "Leong_Risk_29_dn")

samp_tbsignatures <- TBsignatures

samp_tbsignatures$Hoang_OD_3 <- NULL
samp_tbsignatures$Suliman_RISK_2 <- NULL
samp_tbsignatures$Chendi_HIV_2 <- NULL


gsva_res <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```
#### Boxplot- select sigs

```{r m2-ssgsea-boxplot-selectsigs}
indata_m2 = indata[,colData(indata)$visit=="Month 2"]


# select_tbsignatures blocked here, change at baseline figure
# select_tbsignatures <- list(TBsignatures$Thompson_FAIL_13,
#                             TBsignatures$Tornheim_RES_25,
#                             TBsignatures$Tornheim_71, 
#                             TBsignatures$Bloom_RES_558,
#                             TBsignatures$Bloom_RES_268,
#                             TBsignatures$Thompson_RES_5,
#                             TBsignatures$Heycken_FAIL_22,
#                             TBsignatures$Zimmer_RES_3)
# names(select_tbsignatures) <- c("Thompson_FAIL_13",
#                             "Tornheim_RES_25",
#                             "Tornheim_71", 
#                             "Bloom_RES_558",
#                             "Bloom_RES_268",
#                             "Thompson_RES_5",
#                             "Heycken_FAIL_22",
#                             "Zimmer_RES_3")

ssgsea_res_select <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)

# svg("ssgsea_selectsig_boxplot_m2.svg", width = 6.5, pointsize = 8)
# signatureBoxplot(ssgsea_res_select, name="ssGSEA", signatureColNames = names(select_tbsignatures),
#                  annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
# dev.off()
```
### GSVA {.tabset}

#### Heatmap

```{r M2-gsva-heatmap}
signatureHeatmap(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r M2-gsva-boxplot}
signatureBoxplot(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r M2-gsva-boxplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(gsva_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r M2-gsva-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(gsva_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = TRUE, 
                     column_order = NULL)

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r M2-gsva-auctable, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r M2-gsva-auc-boxplot, message = FALSE}
set.seed(0)
compareBoxplots(gsva_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r M2-gsva-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r M2-gsva-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = gsva_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### ssGSEA {.tabset}

#### Heatmap

```{r M2-ssgsea-heatmap}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r M2-ssgsea-boxplot}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
```

#### Boxplots Single {.tabset}

```{r M2-ssgsea-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("subjtype"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r M2-ssgsea-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r M2-ssgsea-auctable, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r M2-ssgsea-auc-boxplot, message = FALSE}

#svg(filename = "M2-ssgsea-auc-boxplot.svg", pointsize = 8, width = 6.5, height = 3.8) 
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
#dev.off()
```
#### AUC Boxplots, selected sigs {.tabset}
```{r base-ssgsea-auc-boxplot, message = FALSE}

out <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames
write.csv(out, "RePORT-ssgsea-auc-boxplot-scores-m2.csv")
out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()


svg(filename = "RePORT-ssgsea-auc-boxplot-m2.svg", pointsize = 8, width = 6.5, height = 3.8)
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```

#### ROC plots
```{r M2-ssgsea-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r M2-ssgsea-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}


#### Heatmap

```{r M2-plage-cancer-heatmap}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r M2-plage-cancer-boxplot}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r M2-plage-cancer-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r M2-plage-cancer-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = TRUE, 
                     column_order = NULL)

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r M2-plage-cancer-auctable, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots
```{r M2-plage-cancer-auc-boxplot, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r M2-plage-cancer-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r M2-plage-cancer-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```















## TBSigProfiler Pathways at baseline and 2 months {.tabset}
```{r, message=FALSE, results='hide'}


## Add new signatures to the profiler

# TBsignatures$Zhao_NANO_6 <- c("ANKRD22","ATP1A1","BLK","CCR6","DARS2","EXOC2")
# 
# TBsignatures$'CYTO6' <- c("CCL11", "IFNG", "IL15", "IL1B", "IL6", "CXCL10")
# 
# TBsignatures$Leong_RISK_29 <- c("SRBD1", "ZNF419", "SH2D1B","CTSA", "GSTA4", "AGAP9", "MOB3C", "WARS1", "LUC7L", "ZNRF1", "CIRBP", "PRSS53", "APOL6", "TCN2", "MDN1", "SNRNP70", "SLC3A1", "NAGA", "SPDYE5",  "SPSB1", "CCDC14",  "IL31RA", "DERA", "FUT4",
# "NEIL1",   "ENO3",   "CCDC78", "HM13","ZNF202" )
# 
# TBsignatures$Zak_RISK_16 <- c("ANKRD22","APOL1","BATF2" ,"ETV7","FCGR1A", "FCGR1B",  "GBP1","GBP2","GBP4","GBP5", "SCARF1","SEPTIN4", "SERPING1", "STAT1","TAP1","TRAFD1")
# TBsignatures$Suliman_RISK_4 <- c("GAS6", "SEPTIN4", "CD1C", "BLK")
# 
# TBsignatures$'Leong_RISK_29_up' = c("SPSB1","MOB3C","FUT4","DERA","WARS","ZNRF1","SLC3A1","SRBD1",
#                                     "HM13", "CTSA","TCN2", "APOL6","NAGA","IL31RA")
# TBsignatures$'Leong_RISK_29_dn' = c("SH2D1B","AGAP9","ZNF202","NEIL1","LUC7L","CCDC78","PRSS53","ENO3",
#                                     "CIRBP","SNRNP70","ZNF419","CCDC14","GSTA4","MDN1","SPDYE5")

#selected tb signatures
# samp_tbsignatures <- list(TBsignatures$Suliman_RISK_4, TBsignatures$Sweeney_OD_3, TBsignatures$Leong_RISK_29, TBsignatures$Zak_RISK_16, TBsignatures$Leong_RISK_29_up, TBsignatures$Leong_RISK_29_dn)
# names(samp_tbsignatures) <- c("Suliman_RISK_4", "Sweeney_OD_3", "Leong_RISK_29", "Zak_RISK_16", "Leong_RISK_29_up", "Leong_Risk_29_dn")

# samp_tbsignatures <- TBsignatures
# 
# samp_tbsignatures$Hoang_OD_3 <- NULL
# samp_tbsignatures$Suliman_RISK_2 <- NULL
# samp_tbsignatures$Chendi_HIV_2 <- NULL


gsva_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)

```

#### Boxplot- select sigs

```{r all-ssgsea-boxplot-selectsigs}
# CHANGE AT BASELINE
# select_tbsignatures <- list(TBsignatures$Thompson_FAIL_13,
#                             TBsignatures$Tornheim_RES_25,
#                             TBsignatures$Tornheim_71, 
#                             TBsignatures$Bloom_RES_558,
#                             TBsignatures$Bloom_RES_268,
#                             TBsignatures$Thompson_RES_5,
#                             TBsignatures$Heycken_FAIL_22,
#                             TBsignatures$Zimmer_RES_3)
# names(select_tbsignatures) <- c("Thompson_FAIL_13",
#                             "Tornheim_RES_25",
#                             "Tornheim_71", 
#                             "Bloom_RES_558",
#                             "Bloom_RES_268",
#                             "Thompson_RES_5",
#                             "Heycken_FAIL_22",
#                             "Zimmer_RES_3")

ssgsea_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)

svg("ssgsea_selectsig_boxplot_all.svg", width = 6.5, pointsize = 8)
signatureBoxplot(ssgsea_res_select, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = "visit_type", scale = TRUE) #rotateLabels = TRUE,
dev.off()
```


### GSVA {.tabset}

#### Heatmap

```{r all-gsva-heatmap}
signatureHeatmap(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("visit_type"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r all-gsva-boxplot}
signatureBoxplot(gsva_res, name="GSVA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("visit_type"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r all-gsva-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(gsva_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("visit_type"),   
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r all-gsva-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(gsva_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("visit_type",i),
                     showColumnNames = TRUE, 
                     column_order = NULL)

  cat("\n\n")
}

```


### ssGSEA {.tabset}

#### Heatmap

```{r all-ssgsea-heatmap}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("visit_type"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r all-ssgsea-boxplot}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("visit_type"), scale = TRUE) #rotateLabels = TRUE,
```

#### Boxplots Single {.tabset}

```{r all-ssgsea-boxplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("visit_type"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r all-ssgsea-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("visit_type",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```



### PLAGE {.tabset}


#### Heatmap

```{r all-plage-cancer-heatmap}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("visit_type"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r all-plage-cancer-boxplot}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("visit_type"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r all-plage-cancer-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("visit_type"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r all-plage-cancer-sigplots-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("visit_type",i),
                     showColumnNames = TRUE, 
                     column_order = NULL)

  cat("\n\n")
}

```

# New sig {.tabset}
```{r, eval=FALSE}

library(ROCR)
set.seed(101) 
sample <- sample.int(n = nrow(colData(indata_base)), size = floor(.75*nrow(colData(indata_base))), replace = F)

df <- as.data.frame(colData(indata_base))
df_train.1 <- df[sample,]
df_test.1 <- df[-sample,]

train <- indata_base[,colData(indata_base)$subjid %in% df_train$subjid]
test  <- indata_base[, colData(indata_base)$subjid %in% df_test$subjid]

dim(train)
table(colData(train)$subjtype)


#import list of all significant genes
# dfx <- read.csv("ipa_bl_xmdx.csv")
# dfx <- column_to_rownames(dfx, var = "X")

# marix of log_cpm for all genes
mat <- as.matrix(assay(indata, "log_cpm"))

# matrix of log_cpm for all genes in baseline
bl_mat <- as.matrix(assay(indata_base, "log_cpm"))
# only include significant genes in matrix
sig_bl_mat <- t(bl_mat[rownames(dfx),])

df <- as.data.frame(colData(indata_base))

# merging counts of significant genes into colData
df <- merge(df, sig_bl_mat, by = 'row.names', all=T)
## temporary SE with new colData
indata_bl <- indata_base
colData(indata_bl) <- DataFrame(df)

# status we are trying to predict
tx_status = data.frame(indata_base$subjtype)
y <- data.frame()

for (i in (rownames(t(sig_bl_mat)))){
  scores = colData(indata_bl)[[i]]
  pred = (prediction(scores, tx_status))
  perf = performance(pred,"tpr","fpr")
  auc = performance(pred,"auc")@'y.values'[[1]]
  auc = max(auc, 1-auc)
  
  
  tmp <- data.frame(i, auc)
  y <- bind_rows(y, tmp)
  
  #return(y)
  
  # cat("#####", i, "\n")
  # 
  # plot(perf)
  # title("ROC Curve") 
  # text(.6,.2, paste("AUC:",round(auc,3)))
  # 
  # cat("\n\n")
}

```


# New model TBSignatureProfiler testing
```{r}
# 
# path to save
path.dir <- file.path("outs/ml_new_signature")

## select data
indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]


assay <- "log_cpm"
samp_tbsignatures <- TBsignatures


samp_tbsignatures$'FAIL_4' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")

#samp_tbsignatures$'m3' <- m3

samp_tbsignatures$Chendi_HIV_2 <- NULL
#samp_tbsignatures$Kulkarni_HIV_2 <- NULL
#samp_tbsignatures$Sloot_HIV_2 <- NULL
#samp_tbsignatures$Suliman_RISK_2 <- NULL

select_tbsignatures <- list(samp_tbsignatures$Anderson_42, 
                      samp_tbsignatures$Esmail_203, 
                      samp_tbsignatures$Tornheim_71,
                      samp_tbsignatures$Tornheim_RES_25,
                      samp_tbsignatures$FAIL_4, 
                      samp_tbsignatures$Leong_RISK_29,
                      samp_tbsignatures$Thompson_FAIL_13,
                      samp_tbsignatures$Thompson_RES_5,
                      samp_tbsignatures$Maertzdorf_OD_100, 
                      samp_tbsignatures$Jacobsen_3,
                      samp_tbsignatures$Jenum_8)

names(select_tbsignatures) <- c("Anderson_42", 
                      "Esmail_203", 
                      "Tornheim_71",
                      "Tornheim_RES_25",
                      "FAIL_4", 
                      "Leong_RISK_29",
                      "Thompson_FAIL_13",
                      "Thompson_RES_5",
                      "Maertzdorf_OD_100", 
                      "Jacobsen_3",
                      "Jenum_8")



library(ROCR)
set.seed(101) 
sample <- sample.int(n = nrow(colData(indata_base)), size = floor(.75*nrow(colData(indata_base))), replace = F)

df <- as.data.frame(colData(indata_base))
df_train <- df[sample,]
df_test <- df[-sample,]

train <- indata_base[,colData(indata_base)$subjid %in% df_train$subjid]
test  <- indata_base[, colData(indata_base)$subjid %in% df_test$subjid]

train_subjid <- colData(train)$subjid
test_subjid <- colData(test)$subjid
test_subjid.m2 <- gsub("A0|A$", "A2", test_subjid)
test_subjid.m2 <- gsub("X_", "", test_subjid.m2)

all(test_subjid.m2 %in% indata_m2$subjid)
x <- indata_m2$subjid
y <- setdiff(test_subjid.m2, x)

test_indata <- indata_base[,which(colnames(indata_base) %in% test_subjid)]
test_indata.m2 <- indata[,colData(indata)$subjid %in% test_subjid.m2]
train_indata <- indata_base[,which(colnames(indata_base) %in% train_subjid)]



```
## Run TBSignatureProfiler
```{r}
## test data
gsva_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)
### train data
gsva_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)

plage_res.bl <- runTBsigProfiler(indata_base,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)
plage_res <- runTBsigProfiler(indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)
## m2
gsva_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)

# m2 test
ssgsea_res.m2.test <- runTBsigProfiler(test_indata.m2,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.m2.test <- runTBsigProfiler(test_indata.m2,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)
```

### PLAGE test
```{r}
path <- file.path(path.dir, "PLAGE")
```


#### Heatmap of genes
```{r}
svg(file.path(path,"FAIL_4_test_plage_heatmap.svg"), pointsize = 8, height=4, width=4)
signatureGeneHeatmap(plage_res.test, useAssay="log_cpm",
                     samp_tbsignatures[["FAIL_4"]],
                     name = "FAIL_4_test_PLAGE", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "FAIL_4"),
                     showColumnNames = FALSE)
dev.off()
```
#### Boxplots of treatment failures 
```{r}
signatureBoxplot(plage_res.test, 
                 name="FAIL_4", 
                 signatureColNames = "FAIL_4", 
                 annotationColName = c("subjtype"),
                 violinPlot = T,
                 rotateLabels = F)
ggsave(file.path(path, "violin_fail4_test.png"), width=4, height=4)
ggsave(file.path(path, "violin_fail4_test.svg"), width=4, height=4)
```

#### AUC boxplot of PLAGE new Sig and select sigs
```{r}


```

#### Boxplot PLAGE
```{r}
svg(file.path(path,"tbfail_plage_boxplot_selectsig.svg"), pointsize = 8)
signatureBoxplot(plage_res.test, name="PLAGE", signatureColNames = names( select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
dev.off()
```

#### Boxplot PLAGE-all timepoints
```{r}
svg(file.path(path,"tbfail_plage_boxplot_selectsig.svg"), pointsize = 8)
 
signatureBoxplot(plage_res, 
                 name="PLAGE", 
                 signatureColNames = names( select_tbsignatures),
                 annotationColName = c("visit_type"))# , rotateLabels = TRUE)
dev.off()
```


#### AUC boxplots of PLAGE scores for all baseline
```{r}
set.seed(0)
out <- tableAUC(plage_res.bl,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()
svg(filename = file.path(path,"RePORT-plage-auc-boxplot-bl.svg"), pointsize = 8, width = 6.5, height = 3.8)
compareBoxplots(plage_res.bl, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```

#### AUC boxplots of PLAGE scores for all m2
```{r}
set.seed(0)
out <- tableAUC(plage_res.bl,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()

svg(filename = file.path(path,"RePORT-plage-auc-boxplot-m2.svg"), pointsize = 8, width = 6.5, height = 3.8)
compareBoxplots(plage_res.m2, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```

#### AUC table of PLAGE new Sig and select sigs
```{r}
set.seed(0)


bl_test_AUC <- tableAUC(plage_res.test,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(bl_test_AUC)
#write.csv(bl_test_AUC, "bl_test_AUC_ssgsea.csv")
```

#### ROC-inverse plots of new sig
```{r}
plage_res.test.inv <- plage_res.test

plage_res.test.inv$subjtype <- relevel(plage_res.test.inv$subjtype,"Failure")
signatureROCplot(inputData = plage_res.test.inv,
                   signatureColNames = "FAIL_4",
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "FAIL_4", sep = " "))
ggsave(file.path(path, "PLAGE_ROC_FAIL_4_test.svg"), width=4, height=4)
```
#### ROC-inverse plots of new sig M2
```{r}
plage_res.m2.test.inv <- plage_res.m2
# 
plage_res.m2.test.inv$subjtype <- relevel(plage_res.m2.test.inv$subjtype,"Failure")
signatureROCplot(inputData = plage_res.m2.test.inv,
                   signatureColNames = "FAIL_4",
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "FAIL_4", sep = " "))
ggsave(file.path(path, "PLAGE_ROC_FAIL_4_test_m2.svg"), width=4, height=4)
```
### ssGSEA
#### Heatmap of genes
#### Boxplots of treatment failures 



## Test the model with TBSignatureProfiler
```{r}
# path to save
path.dir <- file.path("outs/ml_new_signature")

## select data
indata_base = indata[,colData(indata)$visit=="Baseline"]
indata_m2 = indata[,colData(indata)$visit == "Month 2"]


assay <- "log_cpm"
samp_tbsignatures <- TBsignatures


samp_tbsignatures$'FAIL_4' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")

#samp_tbsignatures$'m3' <- m3

samp_tbsignatures$Chendi_HIV_2 <- NULL
#samp_tbsignatures$Kulkarni_HIV_2 <- NULL
#samp_tbsignatures$Sloot_HIV_2 <- NULL
#samp_tbsignatures$Suliman_RISK_2 <- NULL

test_indata <- indata_base[,which(colnames(indata_base) %in% test_subjid)]

train_indata <- indata_base[,which(colnames(indata_base) %in% train_subjid)]


## test data
gsva_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.test <- runTBsigProfiler(test_indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)
### train data
gsva_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.train <- runTBsigProfiler(train_indata,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)


## m2
gsva_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res.m2 <- runTBsigProfiler(indata_m2,
                             useAssay = assay,
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)

```










### ssGSEA {.tabset}

#### Heatmap

```{r subssgsea_a_TBsigs}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r boxssgsea_TBsigs}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("subjtype"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r genes_ssgsea_TBsigs, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r, message = FALSE}
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
```

#### ROC plots
```{r, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}
```{r}
path <- file.path(path.dir, "PLAGE")
```


#### AUC Table
```{r, message = FALSE}
set.seed(0)
d <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output="data.frame")

write.csv(d, file.path(path, "auc_scores.csv"))
```



#### all_sigs_test Heatmap

```{r plage_TBsigs}
signatureHeatmap(plage_res.test, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r boxplage_TBsigs}
signatureBoxplot(plage_res.test, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r , results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

signatureBoxplot(plage_res.test, 
                 name="FAIL_4", 
                 signatureColNames = "FAIL_4", 
                 annotationColName = c("subjtype"),
                 violinPlot = T,
                 rotateLabels = T)
ggsave(file.path(path, "violin_fail4_test.png"), width=4, height=4)
ggsave(file.path(path, "violin_fail4_test.svg"), width=4, height=4)

```



#### AUC Table ssGSEA
```{r, message = FALSE}
set.seed(0)


bl_test_AUC <- tableAUC(ssgsea_res.test,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(bl_test_AUC)
#write.csv(bl_test_AUC, "bl_test_AUC_ssgsea.csv")
```

#### AUC Table PLAGE
```{r, message = FALSE}
set.seed(0)
bl_test_AUC_plage <- tableAUC(plage_res.test,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = TRUE,
         output = "data.frame")
View(bl_test_AUC_plage)
#write.csv(bl_test_AUC_plage, "bl_test_AUC_plage.csv", append=FALSE)
tableAUC(plage_res.test,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = TRUE)
```

#### ROC plots (ind)
```{r}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```

#### Boxplot ssGSEA

```{r}

select_tbsignatures <- list(samp_tbsignatures$Anderson_42, 
                      samp_tbsignatures$Esmail_203, 
                      samp_tbsignatures$Tornheim_71,
                      samp_tbsignatures$Tornheim_RES_25,
                      samp_tbsignatures$FAIL_4, 
                      samp_tbsignatures$Leong_RISK_29,
                      samp_tbsignatures$Thompson_FAIL_13,
                      samp_tbsignatures$Thompson_RES_5,
                      samp_tbsignatures$Maertzdorf_OD_100, 
                      samp_tbsignatures$Jacobsen_3,
                      samp_tbsignatures$Jenum_8)

names(select_tbsignatures) <- c("Anderson_42", 
                      "Esmail_203", 
                      "Tornheim_71",
                      "Tornheim_RES_25",
                      "FAIL_4", 
                      "Leong_RISK_29",
                      "Thompson_FAIL_13",
                      "Thompson_RES_5",
                      "Maertzdorf_OD_100", 
                      "Jacobsen_3",
                      "Jenum_8")


#svg("tbfail_ssgsea_boxplot_selectsig.svg", pointsize = 8)
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```

#### Boxplot PLAGE
```{r}
#svg("tbfail_plage_boxplot_selectsig.svg", pointsize = 8)
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```


#### Heatmap of signature
```{r}
#png("tbfail_VanValkenburg_FAIL_14_train_plage_heatmap.png", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["VanValkenburg_FAIL_14"]],
                     name = "VanValkenburg_FAIL_14_train_plage", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "VanValkenburg_FAIL_14"),
                     showColumnNames = FALSE)
#dev.off()
```

#### Heatmap of m0_gbm signature
```{r}
#svg("VanValkenburg_FAIL_4_test_plage_heatmap.svg", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["VanValkenburg_FAIL_4"]],
                     name = "VanValkenburg_FAIL_4_train_plage", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "VanValkenburg_FAIL_4"),
                     showColumnNames = FALSE)
#dev.off()
```

# TBSignatureProfiler M2
```{r}
assay <- "log_cpm"
# samp_tbsignatures <- TBsignatures
# 
# 
# samp_tbsignatures$'m0_gbm' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")
# samp_tbsignatures$'m1_drf' <- c("PBLD",
#                                 "PLAGL1",
#                                 "MSLN",
#                                 "NHSL2",
#                                 "TRBV5-1",
#                                 "KIF1B",
#                                 "H2BC20P",
#                                 "HK2P1",
#                                 "SSH1",
#                                 "AC007686.3",
#                                 "EP300",
#                                 "AC024587.1",
#                                 "PRSS51",
#                                 "TRAPPC10" )
# samp_tbsignatures$'m2_xrt' <- c("STAT3",
#                                "PLEKHM3",
#                                "LRRFIP1",
#                                "AC009974.2",
#                                "RREB1",
#                                "RNASEL",
#                                "SSH1",
#                                "HELZ" ,
#                                "PTGIS",
#                                "AC003681.1",
#                                "PLEK",
#                                "ANKRD28",
#                                "KIF13A",
#                                "RAB11FIP1P1",
#                                "IDS",
#                                "ANO6")
# 
# samp_tbsignatures$Chendi_HIV_2 <- NULL
# 





gsva_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)



```



#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_ssgsea.csv")
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_plage.csv")
```

#### ROC plots (ind)
```{r}

for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = plage_res,
                   signatureColNames = i ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}

svg("FAIL4_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_4" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_4", sep = " "))
dev.off()

svg("FAIL14_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_14" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_14", sep = " "))
dev.off()

```

#### Boxplot ssGSEA

```{r}



#svg("tb_fail_boxplot_ssgsea_m2.svg")
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```

#### Boxplot PLAGE
```{r}
png("tb_fail_boxplot_plage_m2.png")
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
dev.off()
```


#### Heatmap of signature
```{r}
png("tbfail_m2xrt_ssgsea_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[["m2_xrt"]],
                     name = "m2_xrt", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m2_xrt"),
                     showColumnNames = FALSE)
dev.off()
```

```{r}
#png("tbfail_m0gbm_plage_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["m0_gbm"]],
                     name = "m0_gbm", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m0_gbm"),
                     showColumnNames = FALSE)
#dev.off()
```




# Nutrition signatures
```{r}
nutsigs <- readr::read_csv("data/Vitamin D signatures_unvalidated.csv")
Vitamin_D_Aigner_35 = c("CD24", 
                          "CDH1", 
                          "CDH11",
                          "CDH3", 
                          "CDH4", 
                          "CLDN7", 
                          "CRB3", 
                          "CXADR",
                          "DMKN", 
                          "DSC2", 
                          "DSP", 
                          "EPCAM",
                          "EPPK1", 
                          "F11R", 
                          "GJB2", 
                          "GJB3",
                          "MAL2", 
                          "MARVELD2", 
                          "MPZL2", 
                          "MUC1", 
                          "OCLN", 
                          "PATJ", 
                          "PCDH7",
                          "PKP3",
                          "PMEPA1",
                          "PPL",
                          "SCEL", 
                          "SFN", 
                          "SH3YL1",
                          "SHROOM3", 
                          "SYTL1",
                         "TACSTD2",
                         "TMEM30B", 
                         "TSPAN1", 
                         "TSPAN15")
View(nutsigs)

samp_tbsignatures <- list(Wang=nutsigs$Genes[1],
                          Kim=nutsigs$Genes[2],
                          Amin=nutsigs$Genes[3])
samp_sigs <- lapply(samp_tbsignatures, str_split, "\\, ")
samp_tbsignatures <- list(Wang=samp_sigs$Wang[[1]],
                  Kim=samp_sigs$Kim[[1]],
                  Amin=samp_sigs$Amin[[1]])
samp_tbsignatures$Vitamin_D_Aigner_35 <- Vitamin_D_Aigner_35


gsva_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "GSVA",
                             signatures = samp_tbsignatures, parallel.sz = 4)
ssgsea_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = samp_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE", signatures = samp_tbsignatures, parallel.sz = 4)
```

#### Boxplot- select sigs

```{r base-ssgsea-boxplot-selectsigs}
path <- file.path("outs/tbsigprofiler_outs/nutrition")
#dir.create(path, recursive = T)
select_tbsignatures <- samp_tbsignatures

ssgsea_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)
ssgsea_res_select.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)
ssgsea_res_select.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "ssGSEA",
                               signatures = select_tbsignatures, parallel.sz = 4)
gsva_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "GSVA",
                               signatures = select_tbsignatures, parallel.sz = 4)
gsva_res_select.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "GSVA",
                               signatures = select_tbsignatures, parallel.sz = 4)
gsva_res_select.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "GSVA",
                               signatures = select_tbsignatures, parallel.sz = 4)

plage_res <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)

plage_res_select <- runTBsigProfiler(indata, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res_select.bl <- runTBsigProfiler(indata_base, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)
plage_res_select.m2 <- runTBsigProfiler(indata_m2, useAssay = "log_cpm", algorithm = "PLAGE",
                               signatures = select_tbsignatures, parallel.sz = 4)



signatureBoxplot(ssgsea_res_select, name="ssGSEA", 
                 signatureColNames = names(select_tbsignatures),
                 annotationColName = c("visit_type"), scale = TRUE,
                 rotateLabels = T) + 
               labs(fill = "Group") +
               xlab(element_blank()) +
               ylab("Score")


ggsave(file.path(path,"ssGSEA/nutrition_sigs_alltimepoint_boxplots.svg"), width = 7, height=5)
ggsave(file.path(path,"ssGSEA/nutrition_sigs_alltimepoint_boxplots.png"), width = 7, height=5)

signatureBoxplot(gsva_res_select, name="GSVA", 
                 signatureColNames = names(select_tbsignatures),
                 annotationColName = c("visit_type"), scale = TRUE,
                 rotateLabels = T) + 
               labs(fill = "Group") +
               xlab(element_blank()) +
               ylab("Score")


ggsave(file.path(path,"GSVA/nutrition_sigs_alltimepoint_boxplots.svg"), width = 7, height=5)
ggsave(file.path(path,"GSVA/nutrition_sigs_alltimepoint_boxplots.png"), width = 7, height=5)

signatureBoxplot(plage_res_select, name="PLAGE", 
                 signatureColNames = names(select_tbsignatures),
                 annotationColName = c("visit_type"), scale = TRUE,
                 rotateLabels = T) + 
               labs(fill = "Group") +
               xlab(element_blank()) +
               ylab("Score")


ggsave(file.path(path,"PLAGE/nutrition_sigs_alltimepoint_boxplots.svg"), width = 7, height=5)
ggsave(file.path(path,"PLAGE/nutrition_sigs_alltimepoint_boxplots.png"), width = 7, height=5)

```

#### Kim signature only
```{r}
TBSignatureProfiler::signatureBoxplot(ssgsea_res_select,
                                     name = "Kim", 
                                     signatureColNames = "Kim", 
                                     annotationColName = "visit_type", rotateLabels = T) + 
               labs(fill = "Group") +
               xlab(element_blank()) +
               ylab("Score")
ggsave(file.path(path,"ssGSEA/KIM_nutrition_sigs_alltimepoint_boxplots.png"), width = 5, height=5)


df.bl <- TBSignatureProfiler::tableAUC(ssgsea_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

df.m2 <- TBSignatureProfiler::tableAUC(ssgsea_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

                                    
```
#### Vitamin_D_Aigner_35 signature only
```{r}
TBSignatureProfiler::signatureBoxplot(ssgsea_res_select,
                                     name = "Vitamin_D_Aigner_35", 
                                     signatureColNames = "Vitamin_D_Aigner_35", 
                                     annotationColName = "visit_type", rotateLabels = T) + 
               labs(fill = "Group") +
               xlab(element_blank()) +
               ylab("Score")
ggsave(file.path(path,"ssGSEA/Vitamin_D_Aigner_35_nutrition_sigs_alltimepoint_boxplots.png"), width = 5, height=5)


df.bl <- TBSignatureProfiler::tableAUC(ssgsea_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

df.m2 <- TBSignatureProfiler::tableAUC(ssgsea_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

                                    
```
#### Heatmaps
```{r}
# Wang
png(file.path(path, "ssGSEA/nutrition_Wang_ssgsea_heatmap_bl.png"), pointsize = 8, width=4, height=4, res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Wang_ssgsea_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "ssGSEA/nutrition_Wang_ssgsea_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Wang_ssgsea_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()

## gsva
png(file.path(path, "GSVA/nutrition_Wang_gsva_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Wang_gsva_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "GSVA/nutrition_Wang_gsva_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Wang_gsva_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()

## plage
png(file.path(path, "PLAGE/nutrition_Wang_plage_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Wang_plage_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
print(signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE)) 
dev.off()


png(file.path(path, "PLAGE/nutrition_Wang_plage_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Wang_plage_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Wang"]],
                     name = "Wang", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Wang"),
                     showColumnNames = FALSE) 
dev.off()

# Kim
png(file.path(path, "ssGSEA/nutrition_Kim_ssgsea_heatmap_bl.png"), pointsize = 8, width=4, height=4, res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Kim_ssgsea_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "ssGSEA/nutrition_Kim_ssgsea_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Kim_ssgsea_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()

## gsva
png(file.path(path, "GSVA/nutrition_Kim_gsva_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Kim_gsva_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "GSVA/nutrition_Kim_gsva_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Kim_gsva_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()

## plage
png(file.path(path, "PLAGE/nutrition_Kim_plage_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Kim_plage_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
print(signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE)) 
dev.off()


png(file.path(path, "PLAGE/nutrition_Kim_plage_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Kim_plage_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Kim"]],
                     name = "Kim", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Kim"),
                     showColumnNames = FALSE) 
dev.off()

# Amin
png(file.path(path, "ssGSEA/nutrition_Amin_ssgsea_heatmap_bl.png"), pointsize = 8, width=4, height=4, res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Amin_ssgsea_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "ssGSEA/nutrition_Amin_ssgsea_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Amin_ssgsea_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()

## gsva
png(file.path(path, "GSVA/nutrition_Amin_gsva_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Amin_gsva_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "GSVA/nutrition_Amin_gsva_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Amin_gsva_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()

## plage
png(file.path(path, "PLAGE/nutrition_Amin_plage_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Amin_plage_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
print(signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE)) 
dev.off()


png(file.path(path, "PLAGE/nutrition_Amin_plage_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Amin_plage_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Amin"]],
                     name = "Amin", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Amin"),
                     showColumnNames = FALSE) 
dev.off()
```
```{r}
# Vitamin_D_Aigner_35
png(file.path(path, "ssGSEA/nutrition_Vitamin_D_Aigner_35_ssgsea_heatmap_bl.png"), pointsize = 8, width=4, height=4, res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Vitamin_D_Aigner_35_ssgsea_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "ssGSEA/nutrition_Vitamin_D_Aigner_35_ssgsea_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "ssGSEA/nutrition_Vitamin_D_Aigner_35_ssgsea_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(ssgsea_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()

## gsva
png(file.path(path, "GSVA/nutrition_Vitamin_D_Aigner_35_gsva_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Vitamin_D_Aigner_35_gsva_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()


png(file.path(path, "GSVA/nutrition_Vitamin_D_Aigner_35_gsva_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "GSVA/nutrition_Vitamin_D_Aigner_35_gsva_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(gsva_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()

## plage
png(file.path(path, "PLAGE/nutrition_Vitamin_D_Aigner_35_plage_heatmap_bl.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Vitamin_D_Aigner_35_plage_heatmap_bl.svg"), pointsize = 8, width=4, height=4)
print(signatureGeneHeatmap(plage_res_select.bl, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE)) 
dev.off()


png(file.path(path, "PLAGE/nutrition_Vitamin_D_Aigner_35_plage_heatmap_m2.png"), pointsize = 8, width=4, height=4,res=300, units="in")
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
svg(file.path(path, "PLAGE/nutrition_Vitamin_D_Aigner_35_plage_heatmap_m2.svg"), pointsize = 8, width=4, height=4)
signatureGeneHeatmap(plage_res_select.m2, useAssay="log_cpm",
                     samp_tbsignatures[["Vitamin_D_Aigner_35"]],
                     name = "Vitamin_D_Aigner_35", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "Vitamin_D_Aigner_35"),
                     showColumnNames = FALSE) 
dev.off()
```


#### AUC tables
##### BL
```{r}
set.seed(0)


df <- tableAUC(ssgsea_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(path, "tbsigprofiler_selectsigs_AUC_boxplots_table_bl_ssGSEA.csv"))

# PLAGE
df <- tableAUC(plage_res_select.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(base_path, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_bl_PLAGE.csv"))

# PLAGE, all sigs
df <- tableAUC(plage_res.bl,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
write.csv(df, file.path(base_path, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_bl_PLAGE.csv"))

```

##### M2
```{r}
path.m2 <- file.path("outs/tbsigprofiler_outs/month2")
set.seed(0)
df <- tableAUC(ssgsea_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

write.csv(df, file.path(path.m2, "ssGSEA/tbsigprofiler_selectsigs_AUC_boxplots_table_m2.csv"))

df <- tableAUC(plage_res_select.m2,
         annotationColName = "subjtype",
         signatureColNames = names(select_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")

write.csv(df, file.path(path.m2, "PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_table_m2.csv"))


```
#### AUC Boxplots
##### BL
```{r}
set.seed(0)
compareBoxplots(ssgsea_res_select.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path,"tbsigprofiler_selectsigs_AUC_boxplots_bl.svg"), width = 7, height=7)

compareBoxplots(plage_res_select.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(base_path,"PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_bl.svg"), width = 7, height=7)

compareBoxplots(plage_res.bl, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(base_path,"PLAGE/tbsigprofiler_AUC_boxplots_bl.svg"), width = 7, height=7)

```





##### M2
```{r}
set.seed(0)
compareBoxplots(ssgsea_res_select.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"ssGSEA/tbsigprofiler_selectsigs_AUC_boxplots_m2.svg"), width = 7, height=7)

compareBoxplots(plage_res_select.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"PLAGE/tbsigprofiler_selectsigs_AUC_boxplots_m2.svg"), width = 7, height=7)

compareBoxplots(plage_res.m2, annotationColName = "subjtype",
                signatureColNames = names(select_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
ggsave(file.path(path.m2,"PLAGE/tbsigprofiler_AUC_boxplots_m2.svg"), width = 7, height=7)

```

#### ROC Plots
#### functions
```{r}
sigroc <- function(inputData, annotationData, signatureColNames, annotationColName, 
  scale = FALSE, choose_colors = c("cornflowerblue", "gray24"), 
  name = "Signatures", nrow = NULL, ncol = NULL) 
{
  if (methods::is(inputData, "SummarizedExperiment")) {
    if (any(duplicated(signatureColNames))) {
      signatureColNames <- unique(signatureColNames)
    }
    if (!all(signatureColNames %in% colnames(SummarizedExperiment::colData(inputData)))) {
      stop("Signature column name not found in inputData.")
    }
    if (!all(annotationColName %in% colnames(SummarizedExperiment::colData(inputData)))) {
      stop("Annotation column name not found in inputData.")
    }
    annotationData <- data.frame(SummarizedExperiment::colData(inputData)[, 
      annotationColName, drop = FALSE])
    inputData <- data.frame(SummarizedExperiment::colData(inputData)[, 
      signatureColNames, drop = FALSE])
  }
  else {
    if (ncol(annotationData) != 1) {
      stop("annotationData must have only one column.")
    }
    annotationColName <- colnames(annotationData)
  }
  if (length(annotationColName) != 1) {
    stop("You must specify a single annotation column name with which\n    to create plots.")
  }
  if (!is.factor(annotationData[, 1])) {
    annotationData[, 1] <- as.factor(annotationData[, 1])
  }
  if (nrow(annotationData) == nrow(inputData)) {
    if (!all(rownames(annotationData) == rownames(inputData))) {
      stop("Annotation data and signature data does not match.")
    }
  }
  else if (nrow(annotationData) == ncol(inputData)) {
    if (!all(rownames(annotationData) == colnames(inputData))) {
      stop("Annotation data and signature data does not match.")
    }
    inputData <- t(inputData)
  }
  else {
    stop("Annotation data and signature data does not match.")
  }
  pathwaydata <- t(inputData)
  if (scale) {
    pathwaydata <- t(scale(t(pathwaydata)))
  }
  inputdf <- data.frame(t(pathwaydata), Group = annotationData[, 
    1])
  plot_dat <- NULL
  for (k in signatureColNames) {
    pred <- ROCit::rocit(inputdf[, k], inputdf$Group)
    plot_n <- as.data.frame(cbind(FPR = round(pred$FPR, 
      4), TPR = round(pred$TPR, 4), Signature = k))
    plot_dat <- rbind(plot_dat, plot_n)
  }
  plot_dat$Signature <- paste(plot_dat$Signature)
  plot_dat$FPR <- as.numeric(paste(plot_dat$FPR))
  plot_dat$TPR <- as.numeric(paste(plot_dat$TPR))
  return(plot_dat)
}

bl <- sigroc(inputData = ssgsea_res_select.bl,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
bl$visit <- rep("Baseline")
m2 <- sigroc(inputData = ssgsea_res_select.m2,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
m2$visit <- rep("Month 2")

plot_dat <- bind_rows(bl, m2)

theplot <- ggplot2::ggplot(data = plot_dat, aes(x = FPR, y = TPR, color=visit)) + 
  ggplot2::geom_line(ggplot2::aes(x = FPR, 
    y = TPR, color=visit), linewidth = 1) + 
    ggplot2::facet_wrap(~Signature, scales = "free", nrow = 3, 
      ncol = 3) + 
  ggplot2::geom_abline(ggplot2::aes(intercept = 0, 
    slope = 1, col = "gray24"), linewidth = 1, linetype = "dashed", 
    show.legend = FALSE) + 
  ggplot2::labs(x = "1-Specificity (FPR)", 
    y = "Sensitivity (TPR)") + 
    ggplot2::theme_classic() + 
    ggplot2::theme(axis.text.x = ggplot2::element_text(angle = 90, 
      hjust = 1))
theplot

ggsave(file.path(path, "tbsignatureprofiler_ROC_bl-m2.svg"), width=7, height=7)
```

##### BL
```{r}
signatureROCplot(inputData = ssgsea_res_select.bl,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
```

##### M2
```{r}
signatureROCplot(inputData = ssgsea_res_select.m2,
                   signatureColNames = names(select_tbsignatures),
                   annotationColName = "subjtype")
```


### ssGSEA {.tabset}
#### Bootstrap
```{r}
library(boot)
library(pwr)

ssgsea_df <- as.data.frame(colData(ssgsea_res))
ssgsea_df <- ssgsea_df[,-c(1:3)]
ssgsea_df <- ssgsea_df[,-c(2:24)]

ssgsea_mx <- t(ssgsea_df[,-1])

ssgsea_se <- SummarizedExperiment(assays=ssgsea_mx,
                                  colData=colData(indata_base))
names(assays(ssgsea_se)) <- "ssgsea"

sds <-apply(assay(ssgsea_se,"ssgsea"),1,sd)
summary(sds) 
#   Min.  1st Qu.   Median     Mean  3rd Qu.     Max. 
#0.007625 0.015738 0.022883 0.027426 0.037734 0.066090 

maxsd<-max(sds)
minsd<-min(sds)
meansd <- mean(sds)

quants <- quantile(sds,c(0.015738 ,0.027426 ,0.037734 ))

### Calculate power

#21 controls 20 Failures
sample_size=10
alp = 0.0001

avg <- power.t.test(n = sample_size, delta = NULL, sd = quants[2], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 
large <- power.t.test(n = sample_size, delta = NULL, sd = quants[3], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 
small <- power.t.test(n = sample_size, delta = NULL, sd = quants[1], sig.level = alp, power = .9, type ="two.sample", alternative = "two.sided") 

small$delta
#[1] 0.01033883
avg$delta
#[1] 0.01065506
large$delta
#[1] 0.01145412
```
#### Heatmap

```{r base-ssgsea-heatmap}
signatureHeatmap(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE, scale = TRUE,
                 split_heatmap='none')
```

#### Boxplot

```{r base-ssgsea-boxplot}
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"), scale = TRUE) #rotateLabels = TRUE,
```



#### Boxplots Single {.tabset}

```{r base-ssgsea-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(ssgsea_res, name=i, signatureColNames = i,
                 annotationColName = c("subjtype"), rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r base-ssgsea-sigplots, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order =  NULL)

  cat("\n\n")
}

```


#### AUC Table
```{r base-ssgsea-auctable, message = FALSE}
set.seed(0)
tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Boxplots {.tabset}
```{r base-ssgsea-auc-boxplot, message = FALSE}
#svg(filename = "base-ssgsea-auc-boxplot.svg", pointsize = 8, width = 6.5, height = 3.8) 
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
#dev.off()
```

#### AUC Boxplots, selected sigs {.tabset}
```{r base-ssgsea-auc-boxplot, message = FALSE}

out <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()


png(filename = file.path(path,"RePORT-ssgsea-auc-boxplot-bl.png"), pointsize = 8, width = 6.5, height = 3.8)
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```


#### ROC plots
```{r base-ssgsea-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r base-ssgsea-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = ssgsea_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```


### PLAGE {.tabset}
```{r}

```


#### Heatmap

```{r base-plage-cancer-heatmap}
signatureHeatmap(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColNames = c("subjtype"),
                 showColumnNames = FALSE,
                 split_heatmap='none')
```


#### Boxplot

```{r base-plage-cancer-boxplot}
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(samp_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
```

#### Boxplots Single {.tabset}

```{r base-plage-cancer-boxplot-ind, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureBoxplot(plage_res,
                         name=i, 
                         signatureColNames = i,
                         annotationColName = c("subjtype"),   
                         ##violinPlot = TRUE,
                         rotateLabels = T))

  cat("\n\n")
}

```

#### Signature plots {.tabset}
```{r base-plage-cancer-sigplots, results="asis"}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[[i]],
                     name = i, signatureColNames = NULL,
                     annotationColNames = c("subjtype",i),
                     showColumnNames = FALSE, 
                     column_order = NULL)

  cat("\n\n")
}

```

#### AUC Table {.tabset}
```{r base-plage-cancer-auctable, message = FALSE}
set.seed(0)
tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)

out <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE, 
         output="data.frame")
# Use dplyr::filter to only select rows with AUC > 0.6 on out object 
# Pipe into a dplyr::select function to only select signames %>% unlist %>% unname
# Save this as signatureColNames

out <- out %>% 
          filter(P.value<0.05) %>% 
          select(Signature) %>% 
          unlist() %>% 
          unname()


png(filename = file.path(path, "RePORT-ssgsea-auc-boxplot-bl.png"), pointsize = 8, width = 6.5, height = 3.8)
set.seed(0)
compareBoxplots(ssgsea_res, annotationColName = "subjtype",
                signatureColNames = out,
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)
dev.off()
```

#### AUC Boxplots
```{r base-plage-cancer-auc-boxplot, message = FALSE}
set.seed(0)
compareBoxplots(plage_res, annotationColName = "subjtype",
                signatureColNames = names(samp_tbsignatures),
                pb.show = FALSE, fill.col = "blue",
                rotateLabels = TRUE)

```

#### ROC plots
```{r base-plage-cancer-roc, message = FALSE, fig.height = 9, fig.width = 12}
signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = names(samp_tbsignatures),
                   annotationColName = "subjtype")

```

#### Separate ROC plots  {.tabset}

```{r base-plage-cancer-roc-ind, results = 'asis', message = FALSE}
for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot_CI(inputData = plage_res,
                   signatureColNames = i,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}
```




## TBSignatureProfiler M2
```{r}
assay <- "log_cpm"
# samp_tbsignatures <- TBsignatures
# 
# 
# samp_tbsignatures$'m0_gbm' <- c("MSLN", "NHSL2", "LRRFIP1", "SLC6A6")
# samp_tbsignatures$'m1_drf' <- c("PBLD",
#                                 "PLAGL1",
#                                 "MSLN",
#                                 "NHSL2",
#                                 "TRBV5-1",
#                                 "KIF1B",
#                                 "H2BC20P",
#                                 "HK2P1",
#                                 "SSH1",
#                                 "AC007686.3",
#                                 "EP300",
#                                 "AC024587.1",
#                                 "PRSS51",
#                                 "TRAPPC10" )
# samp_tbsignatures$'m2_xrt' <- c("STAT3",
#                                "PLEKHM3",
#                                "LRRFIP1",
#                                "AC009974.2",
#                                "RREB1",
#                                "RNASEL",
#                                "SSH1",
#                                "HELZ" ,
#                                "PTGIS",
#                                "AC003681.1",
#                                "PLEK",
#                                "ANKRD28",
#                                "KIF13A",
#                                "RAB11FIP1P1",
#                                "IDS",
#                                "ANO6")
# 
# samp_tbsignatures$Chendi_HIV_2 <- NULL
# 





gsva_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "GSVA",
                             signatures = samp_tbsignatures)

ssgsea_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "ssGSEA",
                             signatures = samp_tbsignatures)

plage_res <- runTBsigProfiler(indata_m2,
                             useAssay = assay, 
                             algorithm = "PLAGE",
                             signatures = samp_tbsignatures)



```



#### AUC Table
```{r, message = FALSE}
set.seed(0)
tableAUC(gsva_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE)
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(ssgsea_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_ssgsea.csv")
```

#### AUC Table
```{r, message = FALSE}
set.seed(0)
x <- tableAUC(plage_res,
         annotationColName = "subjtype",
         signatureColNames = names(samp_tbsignatures),
         num.boot = 100,
         pb.show = FALSE,
         output = "data.frame")
View(x)
#write.csv(x, "m2_test_AUC_plage.csv")
```

#### ROC plots (ind)
```{r}

for (i in names(samp_tbsignatures)){

  cat("#####", i, "\n")

  print(signatureROCplot(inputData = plage_res,
                   signatureColNames = i ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", i, sep = " ")))

  cat("\n\n")
}

svg("FAIL4_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_4" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_4", sep = " "))
dev.off()

svg("FAIL14_roc_plage_m2.svg")
signatureROCplot(inputData = plage_res,
                   signatureColNames = "VanValkenburg_FAIL_14" ,
                   annotationColName = "subjtype",
                   name = paste("ROC plot,", "VanValkenburg_FAIL_14", sep = " "))
dev.off()

```

#### Boxplot ssGSEA

```{r}



#svg("tb_fail_boxplot_ssgsea_m2.svg")
signatureBoxplot(ssgsea_res, name="ssGSEA", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
#dev.off()
```

#### Boxplot PLAGE
```{r}
png("tb_fail_boxplot_plage_m2.png")
signatureBoxplot(plage_res, name="PLAGE", signatureColNames = names(select_tbsignatures),
                 annotationColName = c("subjtype"))# , rotateLabels = TRUE)
dev.off()
```


#### Heatmap of signature
```{r}
png("tbfail_m2xrt_ssgsea_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(ssgsea_res, useAssay="log_cpm",
                     samp_tbsignatures[["m2_xrt"]],
                     name = "m2_xrt", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m2_xrt"),
                     showColumnNames = FALSE)
dev.off()
```

```{r}
#png("tbfail_m0gbm_plage_heatmap_m2.png", pointsize = 8)
signatureGeneHeatmap(plage_res, useAssay="log_cpm",
                     samp_tbsignatures[["m0_gbm"]],
                     name = "m0_gbm", signatureColNames = NULL,
                     annotationColNames = c("subjtype", "m0_gbm"),
                     showColumnNames = FALSE)
#dev.off()
```


# Kiloni's signature
```{r}
nutsigs$Vitamin_D_Aigner_35 = c("CD24", 
                          "CDH1", 
                          "CDH11",
                          "CDH3", 
                          "CDH4", 
                          "CLDN7", 
                          "CRB3", 
                          "CXADR",
                          "DMKN", 
                          "DSC2", 
                          "DSP", 
                          "EPCAM",
                          "EPPK1", 
                          "F11R", 
                          "GJB2", 
                          "GJB3",
                          "MAL2", 
                          "MARVELD2", 
                          "MPZL2", 
                          "MUC1", 
                          "OCLN", 
                          "PATJ", 
                          "PCDH7",
                          "PKP3",
                          "PMEPA1",
                          "PPL",
                          "SCEL", 
                          "SFN", 
                          "SH3YL1",
                          "SHROOM3", 
                          "SYTL1",
                         "TACSTD2",
                         "TMEM30B", 
                         "TSPAN1", 
                         "TSPAN15")
```


# Session Info
```{r}
sessionInfo()

```





